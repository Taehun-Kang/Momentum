# 4. ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„ ìš”ì•½

> ìƒì„¸ ë¬¸ì„œ: [docs/basic/4.ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„ ìƒì„¸.md](../basic/4.ë°ì´í„°ë² ì´ìŠ¤%20ì„¤ê³„%20ìƒì„¸.md)

## ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì•„í‚¤í…ì²˜ ê°œìš”

### ì„¤ê³„ ì›ì¹™

- **ì •ê·œí™”**: 3NF ì¤€ìˆ˜í•˜ë˜ ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ ì„ íƒì  ë¹„ì •ê·œí™”
- **í™•ì¥ì„±**: ìˆ˜í‰ì  í™•ì¥ ê³ ë ¤í•œ íŒŒí‹°ì…”ë‹ ì „ëµ
- **ì‹¤ì‹œê°„ì„±**: Supabase Realtimeì„ í™œìš©í•œ ì¦‰ì‹œ ë™ê¸°í™”
- **ë³´ì•ˆ**: RLS(Row Level Security) ê¸°ë°˜ ë‹¤ì¸µ ë³´ì•ˆ

### ì „ì²´ ER ë‹¤ì´ì–´ê·¸ë¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    YouTube Shorts AI íë ˆì´ì…˜ DB                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    users    â”‚â”€â”€â†’ â”‚  user_profiles   â”‚â”€â”€â†’ â”‚ user_search_patternsâ”‚  â”‚
â”‚  â”‚   (Auth)    â”‚    â”‚  (Preferences)   â”‚    â”‚   (Behavior)        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                     â”‚                        â”‚              â”‚
â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚         â”‚                     â”‚                        â”‚          â”‚   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚cached_videosâ”‚    â”‚keyword_mappings  â”‚    â”‚  search_sessions    â”‚  â”‚
â”‚  â”‚ (YouTube)   â”‚    â”‚   (Keywords)     â”‚    â”‚   (Sessions)        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                     â”‚                        â”‚              â”‚
â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚         â”‚                     â”‚                        â”‚          â”‚   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚trending_    â”‚    â”‚ video_quality_   â”‚    â”‚  video_interactions â”‚  â”‚
â”‚  â”‚keywords     â”‚    â”‚ scores           â”‚    â”‚  (User Actions)     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—ï¸ í•µì‹¬ í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ

### ì‚¬ìš©ì ê´€ë ¨ í…Œì´ë¸”

#### 1ï¸âƒ£ users (Supabase Auth í™•ì¥)

```sql
-- ê¸°ë³¸ ì‚¬ìš©ì ì •ë³´ + í™•ì¥ í•„ë“œ
CREATE TABLE users (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  email varchar(255) UNIQUE NOT NULL,
  name varchar(100),
  avatar_url text,
  user_tier tier_enum DEFAULT 'free',
  subscription_expires_at timestamptz,

  -- ì‚¬ìš©ëŸ‰ ì¶”ì 
  daily_api_usage integer DEFAULT 0,
  monthly_api_usage integer DEFAULT 0,

  -- ì„¤ì • (JSONB)
  settings jsonb DEFAULT '{
    "notifications": true,
    "theme": "light",
    "language": "ko",
    "auto_play": true
  }'::jsonb,

  created_at timestamptz DEFAULT now() NOT NULL,
  updated_at timestamptz DEFAULT now() NOT NULL
);

CREATE TYPE tier_enum AS ENUM ('free', 'premium', 'pro', 'enterprise');
```

#### 2ï¸âƒ£ user_profiles (ê°œì¸í™” í”„ë¡œí•„)

```sql
-- ì‚¬ìš©ì ê°œì¸í™” ë°ì´í„°
CREATE TABLE user_profiles (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES users(id) ON DELETE CASCADE,

  -- ì„ í˜¸ë„ ë²¡í„° (AI ê°œì¸í™”ìš©)
  preference_vector float8[100],  -- 100ì°¨ì› ì„ë² ë”©

  -- ì¹´í…Œê³ ë¦¬ ë° í‚¤ì›Œë“œ ì„ í˜¸ë„
  preferred_categories text[] DEFAULT array['general'],
  preferred_keywords text[] DEFAULT array[]::text[],
  disliked_categories text[] DEFAULT array[]::text[],

  -- ì‹œê°„ëŒ€ë³„ ì„ í˜¸ë„ íŒ¨í„´
  mood_patterns jsonb DEFAULT '{
    "morning": ["energetic", "news", "workout"],
    "afternoon": ["focus", "educational", "productivity"],
    "evening": ["relaxing", "entertainment", "healing"],
    "night": ["calm", "asmr", "sleep"]
  }'::jsonb,

  -- ê°œì¸í™” ì•Œê³ ë¦¬ì¦˜ ê°€ì¤‘ì¹˜
  personalization_weights jsonb DEFAULT '{
    "category_match": 0.30,
    "keyword_relevance": 0.25,
    "temporal_context": 0.15,
    "popularity_score": 0.15,
    "freshness_factor": 0.10,
    "diversity_bonus": 0.05
  }'::jsonb,

  created_at timestamptz DEFAULT now() NOT NULL,
  updated_at timestamptz DEFAULT now() NOT NULL
);
```

#### 3ï¸âƒ£ user_search_patterns (ê²€ìƒ‰ íŒ¨í„´ ë¶„ì„)

```sql
-- ì‚¬ìš©ì í–‰ë™ íŒ¨í„´ ì¶”ì 
CREATE TABLE user_search_patterns (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES users(id) ON DELETE CASCADE,

  -- ê¸°ë³¸ í†µê³„
  total_searches integer DEFAULT 0,
  ai_searches_used integer DEFAULT 0,
  avg_results_clicked integer DEFAULT 0,

  -- ì‹œê°„ íŒ¨í„´ (24ì‹œê°„ ë°°ì—´)
  hourly_activity_pattern integer[24] DEFAULT array_fill(0, array[24]),

  -- ê²€ìƒ‰ ì˜ë„ ë¶„í¬
  search_intent_distribution jsonb DEFAULT '{
    "entertainment": 0.4,
    "education": 0.2,
    "mood_boost": 0.2,
    "trend_following": 0.1,
    "discovery": 0.1
  }'::jsonb,

  -- ìƒí˜¸ì‘ìš© ë©”íŠ¸ë¦­
  interaction_patterns jsonb DEFAULT '{
    "click_through_rate": 0.0,
    "video_completion_rate": 0.0,
    "like_rate": 0.0,
    "return_rate": 0.0
  }'::jsonb,

  last_analyzed_at timestamptz DEFAULT now(),
  created_at timestamptz DEFAULT now() NOT NULL,
  updated_at timestamptz DEFAULT now() NOT NULL
);
```

### ì˜ìƒ ê´€ë ¨ í…Œì´ë¸”

#### 4ï¸âƒ£ cached_videos (YouTube ì˜ìƒ ìºì‹œ)

```sql
-- YouTube ì˜ìƒ ë©”íƒ€ë°ì´í„° ìºì‹œ (ì¤‘ìš”: ì¬ìƒ ê°€ëŠ¥ì„± í™•ì¸)
CREATE TABLE cached_videos (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  video_id varchar(20) UNIQUE NOT NULL,

  -- ê¸°ë³¸ ë©”íƒ€ë°ì´í„°
  title text NOT NULL,
  description text,
  channel_id varchar(30),
  channel_name varchar(255),

  -- ì˜ìƒ ì†ì„±
  duration integer, -- ì´ˆ ë‹¨ìœ„
  view_count bigint,
  like_count integer,
  comment_count integer,

  -- ì¬ìƒ ê°€ëŠ¥ì„± ì²´í¬ (í•µì‹¬!)
  is_playable boolean DEFAULT false,
  is_embeddable boolean DEFAULT false,
  region_restrictions jsonb DEFAULT '{}',
  privacy_status varchar(20) DEFAULT 'private',

  -- URL ì •ë³´
  thumbnail_url text,
  channel_thumbnail_url text,

  -- ë¶„ë¥˜ ì •ë³´
  category_id integer,
  category_name varchar(100),
  tags text[],

  -- ìºì‹œ ê´€ë¦¬
  cache_hit_count integer DEFAULT 0,
  last_accessed_at timestamptz DEFAULT now(),
  cached_at timestamptz DEFAULT now() NOT NULL,
  expires_at timestamptz DEFAULT (now() + interval '7 days'),

  created_at timestamptz DEFAULT now() NOT NULL,
  updated_at timestamptz DEFAULT now() NOT NULL
);
```

#### 5ï¸âƒ£ video_quality_scores (ì˜ìƒ í’ˆì§ˆ ë©”íŠ¸ë¦­)

```sql
-- AI ê¸°ë°˜ ì˜ìƒ í’ˆì§ˆ í‰ê°€
CREATE TABLE video_quality_scores (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  video_id varchar(20) REFERENCES cached_videos(video_id),

  -- AI ë¶„ì„ ì ìˆ˜ (0-1 ë²”ìœ„)
  content_quality_score float DEFAULT 0.0,     -- ì½˜í…ì¸  í’ˆì§ˆ
  thumbnail_attractiveness float DEFAULT 0.0,  -- ì¸ë„¤ì¼ ë§¤ë ¥ë„
  title_effectiveness float DEFAULT 0.0,       -- ì œëª© íš¨ê³¼ì„±

  -- ì°¸ì—¬ë„ ì§€í‘œ
  engagement_rate float DEFAULT 0.0,           -- ì°¸ì—¬ìœ¨
  retention_rate float DEFAULT 0.0,            -- ì‹œì²­ ì™„ë£Œìœ¨
  viral_potential float DEFAULT 0.0,           -- ë°”ì´ëŸ´ ê°€ëŠ¥ì„±

  -- ì±„ë„ ì‹ ë¢°ë„
  channel_trust_score float DEFAULT 0.0,       -- ì±„ë„ ì‹ ë¢°ë„
  creator_consistency float DEFAULT 0.0,       -- í¬ë¦¬ì—ì´í„° ì¼ê´€ì„±

  -- ì¢…í•© ì ìˆ˜
  overall_quality_score float DEFAULT 0.0,     -- ì¢…í•© í’ˆì§ˆ ì ìˆ˜

  -- ë¶„ì„ ë©”íƒ€ë°ì´í„°
  analyzed_at timestamptz DEFAULT now(),
  analysis_version varchar(20) DEFAULT 'v1.0',
  confidence_level float DEFAULT 0.0,

  created_at timestamptz DEFAULT now() NOT NULL,
  updated_at timestamptz DEFAULT now() NOT NULL
);
```

#### 6ï¸âƒ£ keyword_video_mappings (í‚¤ì›Œë“œ-ì˜ìƒ ë§¤í•‘)

```sql
-- í‚¤ì›Œë“œì™€ ì˜ìƒì˜ ê´€ë ¨ì„± ë§¤í•‘
CREATE TABLE keyword_video_mappings (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  keyword varchar(255) NOT NULL,
  video_id varchar(20) REFERENCES cached_videos(video_id),

  -- ê´€ë ¨ì„± ì ìˆ˜
  relevance_score float DEFAULT 0.0,           -- í‚¤ì›Œë“œ ê´€ë ¨ì„± (0-1)
  search_rank integer,                         -- ê²€ìƒ‰ ê²°ê³¼ ìˆœìœ„

  -- ë§¤í•‘ ì†ŒìŠ¤ ë° ì‹ ë¢°ë„
  mapping_source varchar(50),                  -- 'youtube_api', 'ai_analysis', 'user_feedback'
  confidence_level float DEFAULT 0.0,          -- ì‹ ë¢°ë„ (0-1)

  -- ì„±ëŠ¥ ë©”íŠ¸ë¦­
  click_through_rate float DEFAULT 0.0,        -- í´ë¦­ë¥ 
  user_satisfaction_score float DEFAULT 0.0,   -- ì‚¬ìš©ì ë§Œì¡±ë„

  created_at timestamptz DEFAULT now() NOT NULL,
  updated_at timestamptz DEFAULT now() NOT NULL,

  UNIQUE(keyword, video_id)
);
```

### íŠ¸ë Œë“œ ê´€ë ¨ í…Œì´ë¸”

#### 7ï¸âƒ£ trending_keywords (íŠ¸ë Œë“œ í‚¤ì›Œë“œ)

```sql
-- ì‹¤ì‹œê°„ íŠ¸ë Œë“œ í‚¤ì›Œë“œ ì¶”ì 
CREATE TABLE trending_keywords (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  keyword varchar(255) NOT NULL,

  -- íŠ¸ë Œë“œ ë©”íŠ¸ë¦­
  trend_score float DEFAULT 0.0,               -- íŠ¸ë Œë“œ ì ìˆ˜ (0-1)
  search_volume integer DEFAULT 0,             -- ê²€ìƒ‰ëŸ‰
  growth_rate float DEFAULT 0.0,               -- ì„±ì¥ë¥  (%)
  velocity float DEFAULT 0.0,                  -- ìƒìŠ¹/í•˜ë½ ì†ë„

  -- ë¶„ë¥˜ ì •ë³´
  category varchar(100),
  subcategory varchar(100),
  related_keywords text[],

  -- ì†ŒìŠ¤ ì •ë³´
  data_source varchar(50),                     -- 'bright_data', 'youtube_api', 'internal'
  source_confidence float DEFAULT 0.0,         -- ì†ŒìŠ¤ ì‹ ë¢°ë„

  -- ì˜ˆì¸¡ ì •ë³´
  predicted_peak_time timestamptz,             -- ì˜ˆìƒ í”¼í¬ ì‹œê°„
  predicted_duration interval,                 -- ì˜ˆìƒ ì§€ì† ì‹œê°„

  -- ì§€ì—­ë³„ ì¸ê¸°ë„
  regional_popularity jsonb DEFAULT '{
    "KR": 0.0,
    "US": 0.0,
    "JP": 0.0,
    "global": 0.0
  }'::jsonb,

  -- ì‹œê³„ì—´ ë°ì´í„°
  hourly_trend_data jsonb DEFAULT '[]'::jsonb, -- 24ì‹œê°„ ì¶”ì´
  daily_trend_data jsonb DEFAULT '[]'::jsonb,  -- 7ì¼ ì¶”ì´

  detected_at timestamptz DEFAULT now(),
  expires_at timestamptz DEFAULT (now() + interval '4 hours'),

  created_at timestamptz DEFAULT now() NOT NULL,
  updated_at timestamptz DEFAULT now() NOT NULL
);
```

### ìƒí˜¸ì‘ìš© ì¶”ì  í…Œì´ë¸”

#### 8ï¸âƒ£ search_sessions (ê²€ìƒ‰ ì„¸ì…˜)

```sql
-- ì‚¬ìš©ì ê²€ìƒ‰ ì„¸ì…˜ ìƒì„¸ ì¶”ì 
CREATE TABLE search_sessions (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES users(id) ON DELETE SET NULL,
  session_token varchar(100),

  -- ê²€ìƒ‰ ì •ë³´
  search_query text NOT NULL,
  search_type varchar(50) DEFAULT 'keyword',    -- 'keyword', 'ai_chat', 'trending'
  search_intent varchar(50),                    -- 'entertainment', 'education', etc.

  -- ì»¨í…ìŠ¤íŠ¸ ì •ë³´
  user_context jsonb DEFAULT '{
    "device_type": "unknown",
    "browser": "unknown",
    "location": "unknown",
    "time_of_day": "unknown",
    "weather": "unknown"
  }'::jsonb,

  -- ê²°ê³¼ ë° ì„±ëŠ¥
  results_count integer DEFAULT 0,
  results_shown integer DEFAULT 0,
  results_clicked integer DEFAULT 0,
  response_time_ms integer DEFAULT 0,           -- ì‘ë‹µ ì‹œê°„ (ms)
  cache_hit boolean DEFAULT false,              -- ìºì‹œ íˆíŠ¸ ì—¬ë¶€
  api_cost_units integer DEFAULT 0,             -- API ë¹„ìš© (units)

  -- ë§Œì¡±ë„ ì¸¡ì •
  user_satisfaction_rating integer,             -- 1-5 ì ìˆ˜
  session_outcome varchar(50),                  -- 'satisfied', 'partial', 'abandoned'

  -- ë„¤íŠ¸ì›Œí¬ ì •ë³´
  ip_address inet,
  user_agent text,

  session_started_at timestamptz DEFAULT now(),
  session_ended_at timestamptz,

  created_at timestamptz DEFAULT now() NOT NULL,
  updated_at timestamptz DEFAULT now() NOT NULL
);
```

#### 9ï¸âƒ£ video_interactions (ì˜ìƒ ìƒí˜¸ì‘ìš©)

```sql
-- ì‚¬ìš©ìì™€ ì˜ìƒ ê°„ì˜ ëª¨ë“  ìƒí˜¸ì‘ìš© ì¶”ì 
CREATE TABLE video_interactions (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES users(id) ON DELETE CASCADE,
  video_id varchar(20) REFERENCES cached_videos(video_id),
  session_id uuid REFERENCES search_sessions(id),

  -- ìƒí˜¸ì‘ìš© íƒ€ì…
  interaction_type varchar(50) NOT NULL,        -- 'view', 'like', 'share', 'save', 'skip'
  interaction_value integer DEFAULT 1,          -- ìƒí˜¸ì‘ìš© ê°•ë„

  -- ì‹œì²­ ì •ë³´
  watch_duration integer DEFAULT 0,             -- ì‹œì²­ ì‹œê°„ (ì´ˆ)
  watch_percentage float DEFAULT 0.0,           -- ì‹œì²­ ë¹„ìœ¨ (0-1)
  watched_to_end boolean DEFAULT false,         -- ëê¹Œì§€ ì‹œì²­ ì—¬ë¶€

  -- í´ë¦­ ì •ë³´
  clicked_thumbnail boolean DEFAULT false,      -- ì¸ë„¤ì¼ í´ë¦­
  clicked_title boolean DEFAULT false,          -- ì œëª© í´ë¦­
  opened_in_youtube boolean DEFAULT false,      -- YouTubeì—ì„œ ì—´ê¸°

  -- í”¼ë“œë°±
  user_rating integer,                          -- 1-5 ì ìˆ˜
  feedback_text text,                           -- í…ìŠ¤íŠ¸ í”¼ë“œë°±

  -- ì»¨í…ìŠ¤íŠ¸
  interaction_context jsonb DEFAULT '{
    "source": "search_results",
    "position": 0,
    "recommendation_score": 0.0
  }'::jsonb,

  interaction_timestamp timestamptz DEFAULT now(),

  created_at timestamptz DEFAULT now() NOT NULL,
  updated_at timestamptz DEFAULT now() NOT NULL
);
```

## ğŸ“ˆ ê³ ê¸‰ ì¸ë±ì‹± ì „ëµ

### ì„±ëŠ¥ ìµœì í™” ì¸ë±ìŠ¤

```sql
-- 1. ì¬ìƒ ê°€ëŠ¥í•œ Shorts ê²€ìƒ‰ ìµœì í™” (í•µì‹¬!)
CREATE INDEX idx_cached_videos_playable_duration
ON cached_videos(is_playable, duration)
WHERE is_playable = true AND duration <= 60;

-- 2. í‚¤ì›Œë“œ ë§¤í•‘ ê²€ìƒ‰ ìµœì í™”
CREATE INDEX idx_keyword_mappings_relevance
ON keyword_video_mappings(keyword, relevance_score DESC)
WHERE relevance_score > 0.7;

-- 3. ì‚¬ìš©ì í™œë™ ì‹œê³„ì—´ ìµœì í™”
CREATE INDEX idx_search_sessions_user_time
ON search_sessions(user_id, session_started_at DESC);

CREATE INDEX idx_video_interactions_user_recent
ON video_interactions(user_id, interaction_timestamp DESC)
WHERE interaction_type = 'view';

-- 4. íŠ¸ë Œë“œ ì ìˆ˜ ì •ë ¬ ìµœì í™”
CREATE INDEX idx_trending_keywords_score_time
ON trending_keywords(trend_score DESC, detected_at DESC);

-- 5. JSONB ë°ì´í„° ìµœì í™” (GIN ì¸ë±ìŠ¤)
CREATE INDEX idx_user_settings_gin
ON users USING GIN (settings);

CREATE INDEX idx_user_context_gin
ON search_sessions USING GIN (user_context);

CREATE INDEX idx_trend_regional_gin
ON trending_keywords USING GIN (regional_popularity);

-- 6. ë³µí•© ê²€ìƒ‰ ìµœì í™”
CREATE INDEX idx_videos_category_quality
ON cached_videos(category_name, view_count DESC)
WHERE is_playable = true;
```

### ì‹œê³„ì—´ íŒŒí‹°ì…”ë‹ ì „ëµ

```sql
-- ëŒ€ìš©ëŸ‰ ë¡œê·¸ í…Œì´ë¸” ì›”ë³„ íŒŒí‹°ì…”ë‹
CREATE TABLE search_sessions_partitioned (
  LIKE search_sessions INCLUDING ALL
) PARTITION BY RANGE (session_started_at);

-- ì›”ë³„ íŒŒí‹°ì…˜ ìë™ ìƒì„± í•¨ìˆ˜
CREATE OR REPLACE FUNCTION create_monthly_partition(
  table_name text,
  start_date date
) RETURNS void AS $$
DECLARE
  partition_name text;
  end_date date;
BEGIN
  partition_name := table_name || '_' || to_char(start_date, 'YYYY_MM');
  end_date := start_date + interval '1 month';

  EXECUTE format('CREATE TABLE %I PARTITION OF %I
                  FOR VALUES FROM (%L) TO (%L)',
                  partition_name, table_name, start_date, end_date);
END;
$$ LANGUAGE plpgsql;
```

## ğŸ”’ ë³´ì•ˆ ë° ê¶Œí•œ ê´€ë¦¬

### 5ë‹¨ê³„ ë³´ì•ˆ ë ˆë²¨ (RLS ì •ì±…)

```sql
-- 1. ìµëª… ì‚¬ìš©ì (ì œí•œëœ ì ‘ê·¼)
CREATE POLICY "anonymous_limited_read" ON cached_videos
  FOR SELECT USING (is_playable = true AND view_count > 1000);

-- 2. ì¸ì¦ëœ ì‚¬ìš©ì (ê¸°ë³¸ ì ‘ê·¼)
CREATE POLICY "authenticated_basic_read" ON cached_videos
  FOR SELECT USING (is_playable = true);

CREATE POLICY "users_own_data" ON user_profiles
  FOR ALL USING (user_id = auth.uid());

-- 3. í”„ë¦¬ë¯¸ì—„ ì‚¬ìš©ì (ê³ ê¸‰ ê¸°ëŠ¥)
CREATE POLICY "premium_advanced_features" ON trending_keywords
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE id = auth.uid()
      AND user_tier IN ('premium', 'pro', 'enterprise')
    )
  );

-- 4. ê´€ë¦¬ì (ì „ì²´ ì ‘ê·¼)
CREATE POLICY "admin_full_access" ON search_sessions
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE id = auth.uid()
      AND user_tier = 'enterprise'
      AND settings->>'role' = 'admin'
    )
  );
```

### ì»¬ëŸ¼ ë ˆë²¨ ì•”í˜¸í™”

```sql
-- ë¯¼ê°í•œ ë°ì´í„° ì•”í˜¸í™” (pgcrypto í™•ì¥)
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- ì•”í˜¸í™” í•¨ìˆ˜
CREATE OR REPLACE FUNCTION encrypt_personal_data(data jsonb)
RETURNS text AS $$
BEGIN
  RETURN pgp_sym_encrypt(
    data::text,
    current_setting('app.encryption_key')
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ë³µí˜¸í™” í•¨ìˆ˜
CREATE OR REPLACE FUNCTION decrypt_personal_data(encrypted_data text)
RETURNS jsonb AS $$
BEGIN
  RETURN pgp_sym_decrypt(
    encrypted_data,
    current_setting('app.encryption_key')
  )::jsonb;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

## ğŸš€ Supabase íŠ¹í™” ê¸°ëŠ¥

### Realtime êµ¬ë… ì„¤ì •

```sql
-- íŠ¸ë Œë“œ í‚¤ì›Œë“œ ì‹¤ì‹œê°„ êµ¬ë…
ALTER PUBLICATION supabase_realtime
ADD TABLE trending_keywords;

-- ì‚¬ìš©ìë³„ ê²€ìƒ‰ ê²°ê³¼ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
ALTER PUBLICATION supabase_realtime
ADD TABLE search_sessions;

-- í•„í„°ë§ëœ ì‹¤ì‹œê°„ êµ¬ë…
CREATE PUBLICATION user_specific_updates
FOR TABLE user_profiles, video_interactions
WHERE (user_id = auth.uid());
```

### Edge Functions íŠ¸ë¦¬ê±°

```sql
-- ìƒˆë¡œìš´ íŠ¸ë Œë“œ ê°ì§€ ì‹œ ì•Œë¦¼
CREATE OR REPLACE FUNCTION notify_trending_keyword()
RETURNS trigger AS $$
BEGIN
  -- Edge Function í˜¸ì¶œë¡œ ì‹¤ì‹œê°„ ì•Œë¦¼
  PERFORM net.http_post(
    url := 'https://your-project.supabase.co/functions/v1/notify-trend',
    headers := '{"Content-Type": "application/json"}',
    body := json_build_object(
      'keyword', NEW.keyword,
      'trend_score', NEW.trend_score,
      'category', NEW.category
    )::text
  );

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trending_keyword_notification
  AFTER INSERT ON trending_keywords
  FOR EACH ROW
  WHEN (NEW.trend_score > 0.8)
  EXECUTE FUNCTION notify_trending_keyword();
```

### ìë™ ë°±ì—… ë° ìœ ì§€ë³´ìˆ˜

```sql
-- ìë™ ì •ë¦¬ í•¨ìˆ˜
CREATE OR REPLACE FUNCTION cleanup_old_data()
RETURNS void AS $$
BEGIN
  -- ë§Œë£Œëœ ìºì‹œ ì‚­ì œ
  DELETE FROM cached_videos
  WHERE expires_at < now() - interval '1 day';

  -- ì˜¤ë˜ëœ ê²€ìƒ‰ ì„¸ì…˜ ì•„ì¹´ì´ë¸Œ
  DELETE FROM search_sessions
  WHERE session_started_at < now() - interval '90 days';

  -- í†µê³„ ì—…ë°ì´íŠ¸
  REFRESH MATERIALIZED VIEW user_activity_summary;
END;
$$ LANGUAGE plpgsql;

-- ì •ê¸° ì‹¤í–‰ (cron í™•ì¥)
SELECT cron.schedule(
  'cleanup-old-data',
  '0 2 * * *',  -- ë§¤ì¼ ìƒˆë²½ 2ì‹œ
  'SELECT cleanup_old_data()'
);
```

## ğŸ“Š ëª¨ë‹ˆí„°ë§ ë° í—¬ìŠ¤ ì²´í¬

### ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ë·°

```sql
-- ì‹¤ì‹œê°„ ì„±ëŠ¥ ëŒ€ì‹œë³´ë“œ
CREATE VIEW performance_dashboard AS
SELECT
  -- ìºì‹œ íš¨ìœ¨ì„±
  (SELECT count(*) FROM cached_videos
   WHERE last_accessed_at > now() - interval '1 hour') as active_cache_count,
  (SELECT avg(cache_hit_count) FROM cached_videos
   WHERE cache_hit_count > 0) as avg_cache_hits,

  -- ê²€ìƒ‰ ì„±ëŠ¥
  (SELECT avg(response_time_ms) FROM search_sessions
   WHERE session_started_at > now() - interval '1 hour') as avg_response_time,
  (SELECT count(*) FROM search_sessions
   WHERE cache_hit = true AND session_started_at > now() - interval '1 hour') as cache_hit_count,

  -- ì‚¬ìš©ì í™œë™
  (SELECT count(distinct user_id) FROM search_sessions
   WHERE session_started_at > now() - interval '1 hour') as active_users,
  (SELECT avg(user_satisfaction_rating) FROM search_sessions
   WHERE user_satisfaction_rating IS NOT NULL
   AND session_started_at > now() - interval '1 hour') as avg_satisfaction,

  now() as last_updated;
```

### ìš©ëŸ‰ ê´€ë¦¬ ë° ì•„ì¹´ì´ë¹™

```sql
-- í…Œì´ë¸”ë³„ ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§
CREATE VIEW table_size_monitoring AS
SELECT
  schemaname,
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size,
  pg_total_relation_size(schemaname||'.'||tablename) as size_bytes
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY size_bytes DESC;

-- ìë™ ì•„ì¹´ì´ë¹™ ì •ì±…
CREATE OR REPLACE FUNCTION auto_archive_policy()
RETURNS void AS $$
DECLARE
  table_info record;
BEGIN
  FOR table_info IN
    SELECT tablename, size_bytes
    FROM table_size_monitoring
    WHERE size_bytes > 1073741824  -- 1GB ì´ìƒ
  LOOP
    -- ëŒ€ìš©ëŸ‰ í…Œì´ë¸” ìë™ íŒŒí‹°ì…”ë‹
    EXECUTE 'SELECT partition_large_table(''' || table_info.tablename || ''')';
  END LOOP;
END;
$$ LANGUAGE plpgsql;
```

## ğŸ¯ ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ ëª©í‘œ

### ì‘ë‹µ ì‹œê°„ ëª©í‘œ

- **ê¸°ë³¸ ì¿¼ë¦¬**: < 50ms
- **ë³µí•© ê²€ìƒ‰**: < 200ms
- **íŠ¸ë Œë“œ ë¶„ì„**: < 500ms
- **ì‚¬ìš©ì ê°œì¸í™”**: < 300ms

### ë™ì‹œ ì ‘ì† ëª©í‘œ

- **ë¬´ë£Œ ì‚¬ìš©ì**: 1,000 ë™ì‹œ ì ‘ì†
- **í”„ë¦¬ë¯¸ì—„ ì‚¬ìš©ì**: 10,000 ë™ì‹œ ì ‘ì†
- **ì „ì²´ ì‹œìŠ¤í…œ**: 50,000 ë™ì‹œ ì ‘ì†

### ë°ì´í„° ì²˜ë¦¬ ëª©í‘œ

- **ìºì‹œ ì ì¤‘ë¥ **: > 85%
- **ì¸ë±ìŠ¤ íš¨ìœ¨ì„±**: > 95%
- **ì¿¼ë¦¬ ìµœì í™”ìœ¨**: > 90%
- **ë°±ì—… ë¬´ê²°ì„±**: 100%

## ğŸ“ í•µì‹¬ ì²´í¬ë¦¬ìŠ¤íŠ¸

### í•„ìˆ˜ êµ¬í˜„ ì‚¬í•­

- [ ] **ì¬ìƒ ê°€ëŠ¥ì„± í•„í„°ë§**: is_playable, is_embeddable ì²´í¬
- [ ] **RLS ë³´ì•ˆ ì •ì±…**: ì‚¬ìš©ìë³„ ë°ì´í„° ê²©ë¦¬
- [ ] **JSONB ì¸ë±ì‹±**: ì„¤ì • ë° ì»¨í…ìŠ¤íŠ¸ ë°ì´í„° ìµœì í™”
- [ ] **ì‹œê³„ì—´ íŒŒí‹°ì…”ë‹**: ëŒ€ìš©ëŸ‰ ë¡œê·¸ í…Œì´ë¸” ê´€ë¦¬
- [ ] **ìë™ ì •ë¦¬**: ë§Œë£Œëœ ìºì‹œ ë° ì˜¤ë˜ëœ ë°ì´í„° ì‚­ì œ

### ì„±ëŠ¥ ìµœì í™”

- [ ] **ë³µí•© ì¸ë±ìŠ¤**: ìì£¼ ì‚¬ìš©ë˜ëŠ” ì¿¼ë¦¬ íŒ¨í„´ ìµœì í™”
- [ ] **ìºì‹œ ì „ëµ**: 7ì¼ ì˜ìƒ ìºì‹œ, 4ì‹œê°„ íŠ¸ë Œë“œ ìºì‹œ
- [ ] **ì‹¤ì‹œê°„ êµ¬ë…**: Supabase Realtime í™œìš©
- [ ] **Edge Functions**: ìë™ ì•Œë¦¼ ë° íŠ¸ë¦¬ê±°

### ëª¨ë‹ˆí„°ë§

- [ ] **ì„±ëŠ¥ ëŒ€ì‹œë³´ë“œ**: ì‹¤ì‹œê°„ ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
- [ ] **ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§**: í…Œì´ë¸”ë³„ í¬ê¸° ì¶”ì 
- [ ] **ìë™ ë°±ì—…**: ì •ê¸° ë°ì´í„° ë³´í˜¸
- [ ] **í—¬ìŠ¤ ì²´í¬**: ì‹œìŠ¤í…œ ë¬´ê²°ì„± ê²€ì¦
