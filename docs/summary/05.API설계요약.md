# 5. API ì„¤ê³„ ë° êµ¬í˜„ ìš”ì•½

> ìƒì„¸ ë¬¸ì„œ: [docs/basic/5.API ì„¤ê³„ ë° êµ¬í˜„.md](../basic/5.API%20ì„¤ê³„%20ë°%20êµ¬í˜„.md)

## ğŸ—ï¸ RESTful API ì„¤ê³„ ì›ì¹™

### ê¸°ë³¸ ì„¤ì •

```yaml
Base URL: https://api.shortscurator.com/v1
Protocol: HTTPS only
Format: JSON
Versioning: URL path (/v1, /v2)
Rate Limiting: Token bucket algorithm
Authentication: JWT Bearer tokens
```

### ì„¤ê³„ ì›ì¹™

- **ë¦¬ì†ŒìŠ¤ ì¤‘ì‹¬ URL** ì„¤ê³„ (`/videos/:id`, `/users/:id/profile`)
- **HTTP ë©”ì†Œë“œ** ì˜ë¯¸ë¡ ì  ì‚¬ìš© (GET, POST, PATCH, DELETE)
- **ìƒíƒœ ë¹„ì €ì¥** (Stateless) - ëª¨ë“  ìš”ì²­ì— ì»¨í…ìŠ¤íŠ¸ í¬í•¨
- **ê³„ì¸µì  êµ¬ì¡°** - ì¤‘ì²© ë¦¬ì†ŒìŠ¤ í‘œí˜„
- **ìºì‹œ ê°€ëŠ¥ì„±** - Cache-Control í—¤ë” í™œìš©
- **ì¼ê´€ëœ ì—ëŸ¬ ì‘ë‹µ** - í‘œì¤€í™”ëœ ì—ëŸ¬ í¬ë§·
- **í˜ì´ì§€ë„¤ì´ì…˜** í‘œì¤€í™” - cursor ê¸°ë°˜
- **ë¶€ë¶„ ì‘ë‹µ** ì§€ì› - fields íŒŒë¼ë¯¸í„°

### í‘œì¤€ ì‘ë‹µ êµ¬ì¡°

```javascript
// ì„±ê³µ ì‘ë‹µ
{
  "success": true,
  "data": {
    // ì‹¤ì œ ë°ì´í„°
  },
  "meta": {
    "timestamp": "2025-06-04T10:00:00Z",
    "version": "1.0",
    "request_id": "req_abc123"
  }
}

// ì—ëŸ¬ ì‘ë‹µ
{
  "success": false,
  "error": {
    "code": "RESOURCE_NOT_FOUND",
    "message": "The requested video was not found",
    "details": {
      "video_id": "xyz789"
    }
  },
  "meta": {
    "timestamp": "2025-06-04T10:00:00Z",
    "request_id": "req_abc123"
  }
}

// í˜ì´ì§€ë„¤ì´ì…˜ ì‘ë‹µ
{
  "success": true,
  "data": [...],
  "pagination": {
    "current_page": 1,
    "per_page": 20,
    "total_pages": 10,
    "total_items": 195,
    "has_next": true,
    "has_prev": false
  },
  "meta": {...}
}
```

## ğŸ” ì¸ì¦ ë° ê¶Œí•œ ê´€ë¦¬

### JWT í† í° ì „ëµ

```javascript
// JWT Payload êµ¬ì¡°
{
  // í‘œì¤€ í´ë ˆì„
  "sub": "user_uuid",           // Subject (user ID)
  "iat": 1717491600,            // Issued at
  "exp": 1717495200,            // Expiration (1ì‹œê°„)
  "jti": "token_unique_id",     // JWT ID

  // ì»¤ìŠ¤í…€ í´ë ˆì„
  "user": {
    "id": "user_uuid",
    "email": "user@example.com",
    "tier": "premium",
    "tier_expires": "2025-12-31T23:59:59Z"
  },
  "permissions": [
    "videos:read",
    "videos:like",
    "ai_chat:use",
    "trends:advanced"
  ],
  "session": {
    "id": "session_uuid",
    "device": "mobile",
    "ip": "1.2.3.4"
  }
}
```

### í† í° ê´€ë¦¬ ì‹œìŠ¤í…œ

```javascript
// í† í° ìƒì„± ë° ê´€ë¦¬
class TokenManager {
  async generateTokenPair(user) {
    // Access Token (1ì‹œê°„)
    const accessToken = jwt.sign(payload, SECRET, {
      expiresIn: "1h",
      issuer: "shortscurator.com",
      audience: "shortscurator-api",
    });

    // Refresh Token (30ì¼)
    const refreshToken = jwt.sign(refreshPayload, REFRESH_SECRET, {
      expiresIn: "30d",
    });

    // í† í° í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ì €ì¥
    await this.storeTokens(user.id, tokenId, refreshToken);

    return { access_token, refresh_token, expires_in: 3600 };
  }

  async verifyAccessToken(token) {
    const decoded = jwt.verify(token, SECRET);

    // ë¸”ë™ë¦¬ìŠ¤íŠ¸ í™•ì¸
    if (await this.isTokenBlacklisted(decoded.jti)) {
      throw new Error("Token has been revoked");
    }

    return decoded;
  }
}
```

### OAuth 2.0 êµ¬í˜„ (Google, Kakao)

```javascript
// OAuth Provider í†µí•©
class OAuthProvider {
  async getAuthorizationUrl(provider, state) {
    const config = this.providers[provider];
    const params = new URLSearchParams({
      client_id: config.clientId,
      redirect_uri: config.redirectUri,
      response_type: "code",
      scope: config.scope?.join(" ") || "",
      state: state,
    });

    const urls = {
      google: `https://accounts.google.com/o/oauth2/v2/auth?${params}`,
      kakao: `https://kauth.kakao.com/oauth/authorize?${params}`,
    };

    return urls[provider];
  }

  async exchangeCodeForTokens(provider, code) {
    // Authorization Code â†’ Access Token êµí™˜
    const response = await fetch(tokenEndpoints[provider], {
      method: "POST",
      body: new URLSearchParams({
        grant_type: "authorization_code",
        code,
        client_id: config.clientId,
        client_secret: config.clientSecret,
        redirect_uri: config.redirectUri,
      }),
    });

    return response.json();
  }
}
```

### Rate Limiting (Token Bucket)

```javascript
// í‹°ì–´ë³„ ì œí•œ ì„¤ì •
const limits = {
  anonymous: { capacity: 100, refillRate: 100, period: 3600 }, // 100/ì‹œê°„
  free: { capacity: 1000, refillRate: 1000, period: 3600 }, // 1,000/ì‹œê°„
  premium: { capacity: 10000, refillRate: 10000, period: 3600 }, // 10,000/ì‹œê°„
  pro: { capacity: 50000, refillRate: 50000, period: 3600 }, // 50,000/ì‹œê°„
};

// Redis Lua ìŠ¤í¬ë¦½íŠ¸ë¡œ ì›ìì  ì²˜ë¦¬
class RateLimiter {
  async checkLimit(userId, userTier = "anonymous") {
    const luaScript = `
      // í† í° ë²„í‚· ì•Œê³ ë¦¬ì¦˜ êµ¬í˜„
      local tokens = tonumber(bucket[1]) or capacity
      local last_refill = tonumber(bucket[2]) or now
      
      // í† í° ë¦¬í•„ ê³„ì‚°
      local elapsed = math.max(0, now - last_refill)
      local refill_amount = math.floor(elapsed / 1000 * refill_rate / period)
      tokens = math.min(capacity, tokens + refill_amount)
      
      if tokens >= requested then
        tokens = tokens - requested
        return {1, tokens, capacity}  // í—ˆìš©
      else
        return {0, tokens, capacity}  // ê±°ë¶€
      end
    `;

    return await redis.eval(luaScript /* params */);
  }
}
```

## ğŸ” í•µì‹¬ API ì—”ë“œí¬ì¸íŠ¸

### 1ï¸âƒ£ ì‚¬ìš©ì ê´€ë¦¬ API (`/api/v1/users/...`)

#### íšŒì›ê°€ì…

```javascript
POST /api/v1/users/register
{
  "email": "user@example.com",
  "password": "password123",
  "username": "user123"
}

// ì‘ë‹µ
{
  "success": true,
  "data": {
    "user": {
      "id": "user_uuid",
      "email": "user@example.com",
      "username": "user123",
      "user_tier": "free"
    },
    "message": "Registration successful. Please check your email for verification."
  }
}
```

#### í”„ë¡œí•„ ê´€ë¦¬

```javascript
// í”„ë¡œí•„ ì¡°íšŒ
GET /api/v1/users/profile
Authorization: Bearer ACCESS_TOKEN

// í”„ë¡œí•„ ìˆ˜ì •
PATCH /api/v1/users/profile
{
  "username": "new_username",
  "preferences": {
    "categories": ["ë¸Œì´ë¡œê·¸", "ë¨¹ë°©", "ASMR"],
    "keywords": ["íë§", "ì›ƒê¸´", "ì‹ ë‚˜ëŠ”"]
  }
}
```

### 2ï¸âƒ£ ê²€ìƒ‰ ë° ì¶”ì²œ API (`/api/v1/search/...`)

#### í‚¤ì›Œë“œ ê²€ìƒ‰ (ê¸°ë³¸)

```javascript
POST /api/v1/search/keywords
{
  "keywords": ["íë§", "ASMR"],
  "filters": {
    "minViews": 100000,
    "maxDuration": 60,
    "category": "entertainment"
  }
}

// ì‘ë‹µ
{
  "success": true,
  "data": {
    "videos": [...],
    "total": 150,
    "keywords": ["íë§", "ASMR"]
  }
}
```

#### AI ëŒ€í™”í˜• ê²€ìƒ‰ (í”„ë¦¬ë¯¸ì—„ ì „ìš©)

```javascript
POST /api/v1/search/chat
Authorization: Bearer ACCESS_TOKEN (Premium required)
{
  "message": "ì˜¤ëŠ˜ ìš°ìš¸í•œë° ê¸°ë¶„ ì¢‹ì•„ì§€ëŠ” ì˜ìƒ ì¶”ì²œí•´ì¤˜",
  "conversationId": "conv_uuid"
}

// ì‘ë‹µ
{
  "success": true,
  "data": {
    "message": "ê¸°ë¶„ ì „í™˜ì— ë„ì›€ë˜ëŠ” íë§ ì˜ìƒë“¤ì„ ì°¾ì•˜ì–´ìš”!",
    "videos": [...],
    "suggestions": ["ASMR ì˜ìƒ", "ì›ƒê¸´ ë™ë¬¼ ì˜ìƒ"],
    "session_id": "session_uuid",
    "keywords": ["íë§", "ê¸°ë¶„ì¢‹ì•„ì§€ëŠ”", "ì¹˜ìœ "]
  }
}
```

#### ì§€ëŠ¥í˜• ì¿¼ë¦¬ (í”„ë¦¬ë¯¸ì—„ ì „ìš©) â­

```javascript
POST /api/v1/search/intelligent-query
{
  "query": "LCK ìµœì‹  ì˜ìƒ",
  "options": {}
}

// ì‘ë‹µ (90% API ì ˆì•½!)
{
  "success": true,
  "data": {
    "original_query": "LCK ìµœì‹  ì˜ìƒ",
    "expanded_queries": [
      {
        "type": "channel_search",
        "channelId": "T1_channel_id",
        "api_cost": 3
      }
    ],
    "web_context": { /* Bright Data ìˆ˜ì§‘ ê²°ê³¼ */ },
    "videos": [...],
    "api_units_saved": 97  // 100 â†’ 3 units
  }
}
```

#### íŠ¸ë Œë”© ì½˜í…ì¸ 

```javascript
GET /api/v1/search/trending?category=entertainment&limit=20

// ì‘ë‹µ
{
  "success": true,
  "data": {
    "trends": [
      {
        "keyword": "ë¨¹ë°©",
        "trend_score": 0.85,
        "category": "entertainment",
        "videos": [...]
      }
    ],
    "updated_at": "2025-06-04T10:00:00Z"
  }
}
```

### 3ï¸âƒ£ ì˜ìƒ ê´€ë ¨ API (`/api/v1/videos/...`)

#### ì˜ìƒ ìƒì„¸ ì¡°íšŒ

```javascript
GET /api/v1/videos/:videoId

// ì‘ë‹µ
{
  "success": true,
  "data": {
    "video": {
      "id": "video_uuid",
      "video_id": "youtube_video_id",
      "title": "íë§ë˜ëŠ” ìì—° ì†Œë¦¬",
      "thumbnail_url": "https://...",
      "channel": {
        "id": "channel_id",
        "title": "íë§ ì±„ë„"
      },
      "statistics": {
        "view_count": 1000000,
        "like_count": 50000
      },
      "duration": 60,
      "quality_score": 0.85,
      "url": "https://youtube.com/shorts/..."
    }
  }
}
```

#### ìƒí˜¸ì‘ìš© ê¸°ë¡

```javascript
POST /api/v1/videos/:videoId/interactions
{
  "type": "view",  // 'view', 'like', 'share', 'save', 'skip'
  "data": {
    "watch_duration": 45,
    "total_duration": 60,
    "source_keyword": "íë§"
  }
}

// ì‘ë‹µ
{
  "success": true,
  "message": "Interaction recorded"
}
```

#### ê´€ë ¨ ì˜ìƒ ì¶”ì²œ

```javascript
GET /api/v1/videos/:videoId/related?limit=20

// ì‘ë‹µ (AI ë¶„ì„ ê¸°ë°˜)
{
  "success": true,
  "data": {
    "videos": [...],
    "based_on": {
      "categories": ["íë§", "ìì—°"],
      "keywords": ["ASMR", "ëª…ìƒ", "ìˆ˜ë©´"]
    }
  }
}
```

### 4ï¸âƒ£ íŠ¸ë Œë“œ API (`/api/v1/trends/...`)

#### ì‹¤ì‹œê°„ íŠ¸ë Œë“œ

```javascript
GET /api/v1/trends/realtime?limit=10

// ì‘ë‹µ (Bright Data MCP ì—°ë™)
{
  "success": true,
  "data": {
    "trends": [
      {
        "keyword": "ì›”ë“œì»µ",
        "trend_score": 0.95,
        "growth_rate": 250.5,
        "source": "bright_data_mcp"
      }
    ],
    "updated_at": "2025-06-04T10:00:00Z"
  }
}
```

#### ì‹œê°„ëŒ€ë³„ íŠ¸ë Œë“œ

```javascript
GET /api/v1/trends/hourly

// ì‘ë‹µ
{
  "success": true,
  "data": {
    "trends": [...],
    "time_context": {
      "hour": 15,
      "time_slot": "afternoon",
      "day_of_week": 1
    }
  }
}
```

#### íŠ¸ë Œë“œ ì˜ˆì¸¡ (í”„ë¡œ í”Œëœ ì „ìš©)

```javascript
POST /api/v1/trends/predict
{
  "keywords": ["AI", "ê²Œì„", "ìš”ë¦¬"],
  "timeframe": "week"
}

// ì‘ë‹µ (MCP ê¸°ë°˜ ì˜ˆì¸¡)
{
  "success": true,
  "data": {
    "predictions": [
      {
        "keyword": "AI",
        "targetDate": "2025-06-11",
        "score": 0.78,
        "confidence": 0.85,
        "lowerBound": 0.65,
        "upperBound": 0.90
      }
    ],
    "model_version": "v1.0"
  }
}
```

## ğŸ“ API ë¬¸ì„œí™”

### OpenAPI 3.0 ìŠ¤í™

```yaml
openapi: 3.0.3
info:
  title: YouTube Shorts Curator API
  description: AI-powered YouTube Shorts curation service API
  version: 1.0.0
  contact:
    email: api@shortscurator.com

servers:
  - url: https://api.shortscurator.com/v1
    description: Production server
  - url: https://staging-api.shortscurator.com/v1
    description: Staging server

security:
  - bearerAuth: []

tags:
  - name: Auth
    description: Authentication endpoints
  - name: Users
    description: User management
  - name: Search
    description: Video search and discovery
  - name: Videos
    description: Video operations
  - name: Trends
    description: Trending content
# ìƒì„¸í•œ Path, Component ì •ì˜...
```

### JavaScript SDK

```javascript
// SDK ì‚¬ìš© ì˜ˆì œ
const sdk = new ShortsCuratorSDK({
  baseURL: "https://api.shortscurator.com/v1",
  accessToken: "YOUR_ACCESS_TOKEN",
});

// í‚¤ì›Œë“œ ê²€ìƒ‰
const results = await sdk.searchKeywords(["ê²Œì„", "ê³µëµ"]);

// AI ì±„íŒ… ê²€ìƒ‰
const chatResults = await sdk.chatSearch("ì˜¤ëŠ˜ ì ì‹¬ ë­ ë¨¹ì„ê¹Œ ê³ ë¯¼ë¼");

// ì˜ìƒ ì‹œì²­ ê¸°ë¡
await sdk.recordInteraction("VIDEO_ID", "view", {
  watch_duration: 30,
  total_duration: 60,
});
```

## ğŸ”’ ë³´ì•ˆ ë° ì„±ëŠ¥

### ë³´ì•ˆ ì¡°ì¹˜

```javascript
// 1. HTTPS ê°•ì œ
app.use((req, res, next) => {
  if (req.header("x-forwarded-proto") !== "https") {
    res.redirect(`https://${req.header("host")}${req.url}`);
  } else {
    next();
  }
});

// 2. CORS ì„¤ì •
app.use(
  cors({
    origin:
      process.env.NODE_ENV === "production"
        ? ["https://shortscurator.com"]
        : true,
    credentials: true,
  })
);

// 3. Helmet ë³´ì•ˆ í—¤ë”
app.use(
  helmet({
    contentSecurityPolicy: {
      directives: {
        defaultSrc: ["'self'"],
        imgSrc: ["'self'", "https://i.ytimg.com"],
        connectSrc: ["'self'", "https://api.youtube.com"],
      },
    },
  })
);

// 4. Input ê²€ì¦
const { body, validationResult } = require("express-validator");

router.post(
  "/endpoint",
  [
    body("email").isEmail().normalizeEmail(),
    body("password")
      .isLength({ min: 8 })
      .matches(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/),
  ],
  (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        success: false,
        error: {
          code: "VALIDATION_ERROR",
          details: errors.array(),
        },
      });
    }
  }
);
```

### ì„±ëŠ¥ ìµœì í™”

```javascript
// 1. ì‘ë‹µ ì••ì¶•
app.use(compression());

// 2. ìºì‹œ í—¤ë” ì„¤ì •
app.use("/api/v1/videos", (req, res, next) => {
  res.set("Cache-Control", "public, max-age=300"); // 5ë¶„
  next();
});

// 3. ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ìµœì í™”
const { data: videos } = await supabase
  .from("cached_videos")
  .select(
    `
    id,
    video_id,
    title,
    thumbnail_url,
    channel_title,
    view_count,
    duration,
    video_quality_scores!inner (
      overall_score
    )
  `
  )
  .eq("is_playable", true)
  .order("view_count", { ascending: false })
  .limit(20);

// 4. ë³‘ë ¬ ì²˜ë¦¬
const [videos, trends, userProfile] = await Promise.all([
  getVideos(keywords),
  getTrends(category),
  getUserProfile(userId),
]);
```

## ğŸ“Š ëª¨ë‹ˆí„°ë§ ë° ë¡œê¹…

### API ë©”íŠ¸ë¦­

```javascript
// ì‘ë‹µ ì‹œê°„ ì¶”ì 
app.use((req, res, next) => {
  const start = Date.now();

  res.on("finish", () => {
    const duration = Date.now() - start;

    // ë©”íŠ¸ë¦­ ìˆ˜ì§‘
    metrics.record("api.response_time", duration, {
      method: req.method,
      route: req.route?.path,
      status_code: res.statusCode,
    });
  });

  next();
});

// ì—ëŸ¬ ì¶”ì 
app.use((error, req, res, next) => {
  logger.error("API Error", {
    error: error.message,
    stack: error.stack,
    request_id: req.id,
    user_id: req.user?.id,
    endpoint: `${req.method} ${req.path}`,
  });

  res.status(500).json({
    success: false,
    error: {
      code: "INTERNAL_ERROR",
      message: "An unexpected error occurred",
    },
  });
});
```

## ğŸ¯ í•µì‹¬ ì²´í¬ë¦¬ìŠ¤íŠ¸

### í•„ìˆ˜ êµ¬í˜„ ì‚¬í•­

- [ ] **JWT í† í° ì‹œìŠ¤í…œ**: Access + Refresh í† í°
- [ ] **OAuth 2.0**: Google, Kakao ì—°ë™
- [ ] **Rate Limiting**: í‹°ì–´ë³„ ì°¨ë“± ì œí•œ
- [ ] **2ë‹¨ê³„ í•„í„°ë§**: ì¬ìƒ ê°€ëŠ¥í•œ ì˜ìƒë§Œ ë°˜í™˜
- [ ] **MCP í†µí•©**: AI ëŒ€í™”í˜• ê²€ìƒ‰ ë° ì§€ëŠ¥í˜• ì¿¼ë¦¬

### ë³´ì•ˆ ë° ì„±ëŠ¥

- [ ] **HTTPS ê°•ì œ**: ëª¨ë“  í†µì‹  ì•”í˜¸í™”
- [ ] **Input ê²€ì¦**: express-validator ì‚¬ìš©
- [ ] **CORS ì„¤ì •**: í—ˆìš©ëœ ë„ë©”ì¸ë§Œ ì ‘ê·¼
- [ ] **ì‘ë‹µ ì••ì¶•**: gzip ì••ì¶• ì ìš©
- [ ] **ìºì‹œ ì „ëµ**: ì ì ˆí•œ Cache-Control í—¤ë”

### ë¬¸ì„œí™” ë° í…ŒìŠ¤íŠ¸

- [ ] **OpenAPI ìŠ¤í™**: ìë™ ë¬¸ì„œ ìƒì„±
- [ ] **Postman ì»¬ë ‰ì…˜**: ìë™ í† í° ê°±ì‹ 
- [ ] **JavaScript SDK**: í´ë¼ì´ì–¸íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬
- [ ] **ë‹¨ìœ„ í…ŒìŠ¤íŠ¸**: ê° ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
- [ ] **í†µí•© í…ŒìŠ¤íŠ¸**: ì „ì²´ ì›Œí¬í”Œë¡œìš° ê²€ì¦

### ëª¨ë‹ˆí„°ë§

- [ ] **ì‘ë‹µ ì‹œê°„**: < 500ms ëª©í‘œ
- [ ] **ì—ëŸ¬ìœ¨**: < 1% ìœ ì§€
- [ ] **API ì‚¬ìš©ëŸ‰**: í‹°ì–´ë³„ ëª¨ë‹ˆí„°ë§
- [ ] **ì‚¬ìš©ì í™œë™**: íŒ¨í„´ ë¶„ì„ ë° ìµœì í™”
