/**
 * ğŸ¬ YouTube ì˜ìƒ í•„í„°ë§ ì„œë¹„ìŠ¤
 * 
 * MCP ì„œë²„ì˜ ëª¨ë“  ì˜ìƒ í•„í„°ë§ ê¸°ëŠ¥ì„ ì™„ì „ êµ¬í˜„
 * - ì¬ìƒ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸ (embeddable, privacy, region)
 * - Shorts ê¸¸ì´ í•„í„°ë§ (5-60ì´ˆ)
 * - í’ˆì§ˆ ê¸°ë°˜ í•„í„°ë§ (ì¡°íšŒìˆ˜, ì¢‹ì•„ìš” ë“±)
 * - ì¤‘ë³µ ì œê±° ë° ì •ë ¬
 */

import axios from 'axios';

class VideoFilter {
  constructor(apiKey) {
    this.apiKey = apiKey;
    this.youtubeApiUrl = 'https://www.googleapis.com/youtube/v3';
    
    // í•„í„°ë§ í†µê³„
    this.stats = {
      totalProcessed: 0,
      playableVideos: 0,
      blockedVideos: 0,
      duplicatesRemoved: 0,
      filteringRatio: 0
    };
  }

  /**
   * ğŸ¯ ì¬ìƒ ê°€ëŠ¥í•œ ì˜ìƒë§Œ í•„í„°ë§ (MCP ì„œë²„ í•µì‹¬ ê¸°ëŠ¥)
   */
  async filterPlayableVideos(videoIds, options = {}) {
    if (!this.apiKey) {
      throw new Error('YouTube API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    }

    if (!videoIds || videoIds.length === 0) {
      return { playableVideos: [], filteringStats: this.getEmptyStats() };
    }

    const {
      regionCode = 'KR',
      maxDuration = 60,
      minDuration = 5,
      requireEmbeddable = true,
      requirePublic = true,
      checkRegionRestrictions = true,
      includeStatistics = true
    } = options;

    console.log(`ğŸ¯ ì˜ìƒ í•„í„°ë§ ì‹œì‘: ${videoIds.length}ê°œ ì˜ìƒ ê²€ì‚¬`);

    try {
      // ë°°ì¹˜ ì²˜ë¦¬ (YouTube APIëŠ” ìµœëŒ€ 50ê°œê¹Œì§€ í•œ ë²ˆì— ì²˜ë¦¬ ê°€ëŠ¥)
      const batches = this.createBatches(videoIds, 50);
      let allPlayableVideos = [];
      let totalApiUnits = 0;

      for (let i = 0; i < batches.length; i++) {
        const batch = batches[i];
        console.log(`ğŸ“¦ ë°°ì¹˜ ${i + 1}/${batches.length} ì²˜ë¦¬ ì¤‘... (${batch.length}ê°œ ì˜ìƒ)`);

        // videos.list API í˜¸ì¶œ
        const parts = ['snippet', 'contentDetails', 'status'];
        if (includeStatistics) parts.push('statistics');

        const response = await axios.get(`${this.youtubeApiUrl}/videos`, {
          params: {
            key: this.apiKey,
            part: parts.join(','),
            id: batch.join(','),
            hl: 'ko',
            regionCode: regionCode
          }
        });

        const videos = response.data.items || [];
        console.log(`ğŸ“Š ë°°ì¹˜ ${i + 1} API ì‘ë‹µ: ${videos.length}/${batch.length}ê°œ ì˜ìƒ ì •ë³´ ìˆ˜ì‹ `);

        // ê° ì˜ìƒì— ëŒ€í•´ ì¬ìƒ ê°€ëŠ¥ ì—¬ë¶€ ê²€ì‚¬
        const batchPlayableVideos = videos.filter(video => {
          return this.isVideoPlayable(video, {
            regionCode,
            maxDuration,
            minDuration,
            requireEmbeddable,
            requirePublic,
            checkRegionRestrictions
          });
        });

        allPlayableVideos.push(...batchPlayableVideos);

        // API ì‚¬ìš©ëŸ‰ ê³„ì‚° (1 + parts.length * 2)
        const batchApiUnits = 1 + (parts.length * 2);
        totalApiUnits += batchApiUnits;

        console.log(`âœ… ë°°ì¹˜ ${i + 1} í•„í„°ë§ ì™„ë£Œ: ${batchPlayableVideos.length}/${videos.length}ê°œ ì¬ìƒ ê°€ëŠ¥`);

        // API í˜¸ì¶œ ê°„ê²© (Rate Limiting ë°©ì§€)
        if (i < batches.length - 1) {
          await this.delay(100);
        }
      }

      // í†µê³„ ì—…ë°ì´íŠ¸
      this.stats.totalProcessed += videoIds.length;
      this.stats.playableVideos += allPlayableVideos.length;
      this.stats.blockedVideos += (videoIds.length - allPlayableVideos.length);
      this.stats.filteringRatio = this.stats.totalProcessed > 0 
        ? (this.stats.playableVideos / this.stats.totalProcessed * 100).toFixed(1)
        : 0;

      console.log(`ğŸŠ í•„í„°ë§ ì™„ë£Œ!`);
      console.log(`  ğŸ“Š ì´ ê²€ì‚¬: ${videoIds.length}ê°œ`);
      console.log(`  âœ… ì¬ìƒ ê°€ëŠ¥: ${allPlayableVideos.length}ê°œ`);
      console.log(`  âŒ ì¬ìƒ ë¶ˆê°€: ${videoIds.length - allPlayableVideos.length}ê°œ`);
      console.log(`  ğŸ“ˆ ì„±ê³µë¥ : ${((allPlayableVideos.length / videoIds.length) * 100).toFixed(1)}%`);
      console.log(`  ğŸ’° API ì‚¬ìš©ëŸ‰: ${totalApiUnits} units`);

      return {
        playableVideos: allPlayableVideos,
        filteringStats: {
          totalChecked: videoIds.length,
          playableCount: allPlayableVideos.length,
          blockedCount: videoIds.length - allPlayableVideos.length,
          successRate: ((allPlayableVideos.length / videoIds.length) * 100).toFixed(1) + '%',
          apiUnitsUsed: totalApiUnits,
          batchesProcessed: batches.length
        }
      };

    } catch (error) {
      console.error('âŒ ì˜ìƒ í•„í„°ë§ ì‹¤íŒ¨:', error);
      throw error;
    }
  }

  /**
   * ğŸ” ê°œë³„ ì˜ìƒ ì¬ìƒ ê°€ëŠ¥ ì—¬ë¶€ ê²€ì‚¬ (MCP ì„œë²„ ë¡œì§)
   */
  isVideoPlayable(video, options = {}) {
    const {
      regionCode = 'KR',
      maxDuration = 60,
      minDuration = 5,
      requireEmbeddable = true,
      requirePublic = true,
      checkRegionRestrictions = true
    } = options;

    try {
      // 1. ì„ë² ë“œ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
      if (requireEmbeddable && !video.status?.embeddable) {
        console.log(`âŒ ${video.id}: ì„ë² ë“œ ë¶ˆê°€ëŠ¥`);
        return false;
      }

      // 2. ê³µê°œ ìƒíƒœ í™•ì¸
      if (requirePublic && video.status?.privacyStatus !== 'public') {
        console.log(`âŒ ${video.id}: ë¹„ê³µê°œ ì˜ìƒ (${video.status?.privacyStatus})`);
        return false;
      }

      // 3. ì§€ì—­ ì°¨ë‹¨ í™•ì¸
      if (checkRegionRestrictions) {
        const restrictions = video.contentDetails?.regionRestriction;
        if (restrictions) {
          // ì°¨ë‹¨ëœ ì§€ì—­ ëª©ë¡ì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
          if (restrictions.blocked?.includes(regionCode)) {
            console.log(`âŒ ${video.id}: ì§€ì—­ ì°¨ë‹¨ë¨ (${regionCode})`);
            return false;
          }
          
          // í—ˆìš©ëœ ì§€ì—­ ëª©ë¡ì´ ìˆê³ , í•´ë‹¹ ì§€ì—­ì´ í¬í•¨ë˜ì§€ ì•Šì€ ê²½ìš°
          if (restrictions.allowed && !restrictions.allowed.includes(regionCode)) {
            console.log(`âŒ ${video.id}: ì§€ì—­ í—ˆìš© ëª©ë¡ì— ì—†ìŒ (${regionCode})`);
            return false;
          }
        }
      }

      // 4. ì˜ìƒ ê¸¸ì´ í™•ì¸ (Shorts ê¸°ì¤€)
      const duration = this.parseISO8601Duration(video.contentDetails?.duration);
      if (duration > maxDuration) {
        console.log(`âŒ ${video.id}: ë„ˆë¬´ ê¸´ ì˜ìƒ (${duration}ì´ˆ > ${maxDuration}ì´ˆ)`);
        return false;
      }
      
      if (duration < minDuration) {
        console.log(`âŒ ${video.id}: ë„ˆë¬´ ì§§ì€ ì˜ìƒ (${duration}ì´ˆ < ${minDuration}ì´ˆ)`);
        return false;
      }

      // 5. ì—…ë¡œë“œ ì‹¤íŒ¨ ë˜ëŠ” ì²˜ë¦¬ ì¤‘ì¸ ì˜ìƒ í™•ì¸
      if (video.status?.uploadStatus !== 'processed') {
        console.log(`âŒ ${video.id}: ì—…ë¡œë“œ ë¯¸ì™„ë£Œ (${video.status?.uploadStatus})`);
        return false;
      }

      // 6. ì—°ë ¹ ì œí•œ í™•ì¸ (ì„ íƒì )
      if (video.contentDetails?.contentRating?.ytRating === 'ytAgeRestricted') {
        console.log(`âš ï¸ ${video.id}: ì—°ë ¹ ì œí•œ ì˜ìƒ`);
        // ì—°ë ¹ ì œí•œ ì˜ìƒë„ í—ˆìš©í•˜ì§€ë§Œ ë¡œê·¸ëŠ” ë‚¨ê¹€
      }

      console.log(`âœ… ${video.id}: ì¬ìƒ ê°€ëŠ¥ (${duration}ì´ˆ)`);
      return true;

    } catch (error) {
      console.error(`âŒ ${video.id}: í•„í„°ë§ ê²€ì‚¬ ì˜¤ë¥˜:`, error);
      return false;
    }
  }

  /**
   * ğŸ¯ í’ˆì§ˆ ê¸°ë°˜ í•„í„°ë§ (ì¡°íšŒìˆ˜, ì¢‹ì•„ìš” ë“±)
   */
  filterByQuality(videos, options = {}) {
    const {
      minViewCount = 1000,
      minLikeCount = 10,
      maxDislikeRatio = 0.1,
      minEngagementRate = 0.01,
      sortBy = 'viewCount' // viewCount, likeCount, publishedAt, relevance
    } = options;

    console.log(`ğŸ¯ í’ˆì§ˆ ê¸°ë°˜ í•„í„°ë§ ì‹œì‘: ${videos.length}ê°œ ì˜ìƒ`);

    const qualityVideos = videos.filter(video => {
      const stats = video.statistics;
      if (!stats) return true; // í†µê³„ê°€ ì—†ìœ¼ë©´ í†µê³¼

      const viewCount = parseInt(stats.viewCount) || 0;
      const likeCount = parseInt(stats.likeCount) || 0;
      const dislikeCount = parseInt(stats.dislikeCount) || 0;
      const commentCount = parseInt(stats.commentCount) || 0;

      // ìµœì†Œ ì¡°íšŒìˆ˜ í™•ì¸
      if (viewCount < minViewCount) {
        console.log(`âŒ ${video.id}: ì¡°íšŒìˆ˜ ë¶€ì¡± (${viewCount} < ${minViewCount})`);
        return false;
      }

      // ìµœì†Œ ì¢‹ì•„ìš” ìˆ˜ í™•ì¸
      if (likeCount < minLikeCount) {
        console.log(`âŒ ${video.id}: ì¢‹ì•„ìš” ë¶€ì¡± (${likeCount} < ${minLikeCount})`);
        return false;
      }

      // ì‹«ì–´ìš” ë¹„ìœ¨ í™•ì¸
      const totalRatings = likeCount + dislikeCount;
      if (totalRatings > 0) {
        const dislikeRatio = dislikeCount / totalRatings;
        if (dislikeRatio > maxDislikeRatio) {
          console.log(`âŒ ${video.id}: ì‹«ì–´ìš” ë¹„ìœ¨ ë†’ìŒ (${(dislikeRatio * 100).toFixed(1)}%)`);
          return false;
        }
      }

      // ì°¸ì—¬ë„ í™•ì¸ (ì¢‹ì•„ìš” + ëŒ“ê¸€) / ì¡°íšŒìˆ˜
      const engagementRate = viewCount > 0 ? (likeCount + commentCount) / viewCount : 0;
      if (engagementRate < minEngagementRate) {
        console.log(`âŒ ${video.id}: ì°¸ì—¬ë„ ë‚®ìŒ (${(engagementRate * 100).toFixed(2)}%)`);
        return false;
      }

      return true;
    });

    // ì •ë ¬
    const sortedVideos = this.sortVideos(qualityVideos, sortBy);

    console.log(`âœ… í’ˆì§ˆ í•„í„°ë§ ì™„ë£Œ: ${sortedVideos.length}/${videos.length}ê°œ ì˜ìƒ í†µê³¼`);

    return sortedVideos;
  }

  /**
   * ğŸ”„ ì¤‘ë³µ ì˜ìƒ ì œê±°
   */
  removeDuplicates(videos, options = {}) {
    const { 
      dedupeBy = 'videoId', // videoId, title, channelId
      keepFirst = true 
    } = options;

    console.log(`ğŸ”„ ì¤‘ë³µ ì œê±° ì‹œì‘: ${videos.length}ê°œ ì˜ìƒ (ê¸°ì¤€: ${dedupeBy})`);

    const seen = new Set();
    const uniqueVideos = [];

    for (const video of videos) {
      let key;
      
      switch (dedupeBy) {
        case 'videoId':
          key = video.id;
          break;
        case 'title':
          key = video.snippet?.title?.toLowerCase().trim();
          break;
        case 'channelId':
          key = video.snippet?.channelId;
          break;
        default:
          key = video.id;
      }

      if (!seen.has(key)) {
        seen.add(key);
        uniqueVideos.push(video);
      } else {
        console.log(`ğŸ”„ ì¤‘ë³µ ì œê±°: ${video.id} (${dedupeBy}: ${key})`);
        this.stats.duplicatesRemoved++;
      }
    }

    console.log(`âœ… ì¤‘ë³µ ì œê±° ì™„ë£Œ: ${uniqueVideos.length}ê°œ ê³ ìœ  ì˜ìƒ (${videos.length - uniqueVideos.length}ê°œ ì œê±°)`);

    return uniqueVideos;
  }

  /**
   * ğŸ“Š ì˜ìƒ ì •ë ¬
   */
  sortVideos(videos, sortBy = 'relevance') {
    console.log(`ğŸ“Š ì˜ìƒ ì •ë ¬: ${sortBy} ê¸°ì¤€`);

    const sortedVideos = [...videos].sort((a, b) => {
      switch (sortBy) {
        case 'viewCount':
          return (parseInt(b.statistics?.viewCount) || 0) - (parseInt(a.statistics?.viewCount) || 0);
        
        case 'likeCount':
          return (parseInt(b.statistics?.likeCount) || 0) - (parseInt(a.statistics?.likeCount) || 0);
        
        case 'publishedAt':
          return new Date(b.snippet?.publishedAt) - new Date(a.snippet?.publishedAt);
        
        case 'duration':
          const durationA = this.parseISO8601Duration(a.contentDetails?.duration);
          const durationB = this.parseISO8601Duration(b.contentDetails?.duration);
          return durationA - durationB;
        
        case 'engagement':
          const engagementA = this.calculateEngagementRate(a);
          const engagementB = this.calculateEngagementRate(b);
          return engagementB - engagementA;
        
        case 'relevance':
        default:
          // ê¸°ë³¸ ê´€ë ¨ì„± ì •ë ¬ (YouTube API ê¸°ë³¸ ìˆœì„œ ìœ ì§€)
          return 0;
      }
    });

    return sortedVideos;
  }

  /**
   * ğŸ“ˆ ì°¸ì—¬ë„ ê³„ì‚°
   */
  calculateEngagementRate(video) {
    const stats = video.statistics;
    if (!stats) return 0;

    const viewCount = parseInt(stats.viewCount) || 0;
    const likeCount = parseInt(stats.likeCount) || 0;
    const commentCount = parseInt(stats.commentCount) || 0;

    return viewCount > 0 ? (likeCount + commentCount) / viewCount : 0;
  }

  /**
   * â±ï¸ ISO 8601 Duration íŒŒì‹± (MCP ì„œë²„ì™€ ë™ì¼)
   */
  parseISO8601Duration(duration) {
    if (!duration || typeof duration !== 'string') {
      return 0;
    }

    try {
      const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
      if (!match) return 0;

      const hours = match[1] ? parseInt(match[1].replace('H', '')) || 0 : 0;
      const minutes = match[2] ? parseInt(match[2].replace('M', '')) || 0 : 0;
      const seconds = match[3] ? parseInt(match[3].replace('S', '')) || 0 : 0;

      return hours * 3600 + minutes * 60 + seconds;
    } catch (error) {
      console.error('Duration parsing error:', error);
      return 0;
    }
  }

  /**
   * ğŸ“¦ ë°°ì¹˜ ìƒì„± (API í˜¸ì¶œ ìµœì í™”)
   */
  createBatches(items, batchSize) {
    const batches = [];
    for (let i = 0; i < items.length; i += batchSize) {
      batches.push(items.slice(i, i + batchSize));
    }
    return batches;
  }

  /**
   * ğŸ“Š í•„í„°ë§ í†µê³„ ì¡°íšŒ
   */
  getStats() {
    return {
      ...this.stats,
      successRate: this.stats.totalProcessed > 0 
        ? ((this.stats.playableVideos / this.stats.totalProcessed) * 100).toFixed(1) + '%'
        : '0%'
    };
  }

  /**
   * ğŸ“Š ë¹ˆ í†µê³„ ê°ì²´
   */
  getEmptyStats() {
    return {
      totalChecked: 0,
      playableCount: 0,
      blockedCount: 0,
      successRate: '0%',
      apiUnitsUsed: 0,
      batchesProcessed: 0
    };
  }

  /**
   * ğŸ”„ ì§€ì—° í•¨ìˆ˜
   */
  async delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}

export default VideoFilter;

/**
 * ğŸ¯ í¸ì˜ í•¨ìˆ˜ë“¤ - ì§ì ‘ ì‚¬ìš© ê°€ëŠ¥
 */

// ì „ì—­ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± í•¨ìˆ˜
function createVideoFilter() {
  const apiKey = process.env.YOUTUBE_API_KEY;
  return new VideoFilter(apiKey);
}

/**
 * ğŸ¯ ì¬ìƒ ê°€ëŠ¥í•œ ì˜ìƒ í•„í„°ë§ (í¸ì˜ í•¨ìˆ˜)
 */
export async function filterVideos(videoIds, options = {}) {
  const filter = createVideoFilter();
  const result = await filter.filterPlayableVideos(videoIds, options);
  return result.playableVideos;
}

/**
 * ğŸ“Š ì˜ìƒ ì •ë ¬ (í¸ì˜ í•¨ìˆ˜)
 */
export function sortVideos(videos, sortBy = 'relevance') {
  const filter = createVideoFilter();
  return filter.sortVideos(videos, sortBy);
}

/**
 * ğŸ”„ ì¤‘ë³µ ì œê±° (í¸ì˜ í•¨ìˆ˜)
 */
export function removeDuplicates(videos, options = {}) {
  const filter = createVideoFilter();
  return filter.removeDuplicates(videos, options);
}

/**
 * ğŸ“Š í•„í„°ë§ í†µê³„ ì¡°íšŒ (í¸ì˜ í•¨ìˆ˜)
 */
export function getFilterStats() {
  const filter = createVideoFilter();
  return filter.getStats();
} 