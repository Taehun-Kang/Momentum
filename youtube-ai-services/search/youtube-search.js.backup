/**
 * ğŸ¬ YouTube ê²€ìƒ‰ ì„œë¹„ìŠ¤
 * 
 * MCP ì„œë²„ì˜ ëª¨ë“  YouTube ê²€ìƒ‰ ê¸°ëŠ¥ì„ ì™„ì „ êµ¬í˜„
 * - 2ë‹¨ê³„ í•„í„°ë§ (search.list â†’ videos.list â†’ playability check)
 * - ìŠ¤ë§ˆíŠ¸ í˜ì´ì§€ë„¤ì´ì…˜ (30ê°œ ë¯¸ë§Œ ì‹œ ìë™ ë‹¤ìŒ í˜ì´ì§€)
 * - ì •í™•í•œ API ì‚¬ìš©ëŸ‰ ê³„ì‚°
 * - ì—„ê²©í•œ Shorts í•„í„°ë§
 */

import axios from 'axios';

class YouTubeSearch {
  constructor(apiKey) {
    this.apiKey = apiKey;
    this.youtubeApiUrl = 'https://www.googleapis.com/youtube/v3';
    
    // í†µê³„ ì¶”ì 
    this.stats = {
      totalRequests: 0,
      successfulRequests: 0,
      failedRequests: 0,
      apiUnitsUsed: 0
    };
  }

  /**
   * ğŸ¬ YouTube Data API v3 ê²€ìƒ‰ (2ë‹¨ê³„ í•„í„°ë§ + ìŠ¤ë§ˆíŠ¸ í˜ì´ì§€ë„¤ì´ì…˜)
   * MCP ì„œë²„ì˜ searchYouTubeVideos ë©”ì„œë“œ ì™„ì „ êµ¬í˜„
   */
  async searchYouTubeVideos(params, maxResults, nextPageToken) {
    if (!this.apiKey) {
      throw new Error('YouTube API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    }

    try {
      let allPlayableVideos = [];
      let currentPageToken = nextPageToken;
      let totalCandidates = 0;
      let totalApiUnits = 0;
      let pageCount = 0;
      const maxPages = 3; // ìµœëŒ€ 3í˜ì´ì§€ê¹Œì§€ë§Œ (API í• ë‹¹ëŸ‰ ë³´í˜¸)

      console.log(`ğŸ¬ YouTube ê²€ìƒ‰ ì‹œì‘: "${params.query}" (ëª©í‘œ: ${maxResults}ê°œ)`);

      // ğŸ“„ í˜ì´ì§€ë³„ ê²€ìƒ‰ ë£¨í”„
      while (allPlayableVideos.length < Math.max(maxResults, 30) && pageCount < maxPages) {
        pageCount++;
        console.log(`\nğŸ“„ í˜ì´ì§€ ${pageCount} ê²€ìƒ‰ ì¤‘...`);

        // 1ë‹¨ê³„: search.listë¡œ í›„ë³´ ì˜ìƒ ê²€ìƒ‰ (ê¸°ë³¸ í•„í„°ë§ ì ìš©)
        console.log('1ï¸âƒ£ YouTube í›„ë³´ ì˜ìƒ ê²€ìƒ‰ ì¤‘... (maxResults=50, ê¸°ë³¸ í•„í„°ë§ ì ìš©)');
        const searchResponse = await axios.get(`${this.youtubeApiUrl}/search`, {
          params: {
            key: this.apiKey,
            part: 'snippet',
            q: params.query,
            type: 'video',
            videoDuration: 'short', // â­ 4ë¶„ ë¯¸ë§Œ (Shorts ê¸¸ì´)
            videoEmbeddable: 'true', // â­ ì„ë² ë“œ ê°€ëŠ¥í•œ ì˜ìƒë§Œ (ê¸°ë³¸ í•„í„°ë§)
            maxResults: 50, // í•­ìƒ ìµœëŒ€ 50ê°œë¡œ ê³ ì •
            regionCode: 'KR',
            relevanceLanguage: 'ko',
            safeSearch: 'moderate',
            order: params.filters?.order || 'relevance',
            pageToken: currentPageToken
          }
        });

        const searchResults = searchResponse.data.items || [];
        totalCandidates += searchResults.length;
        console.log(`ğŸ“Š search.list ê²°ê³¼: ${searchResults.length}ê°œ í›„ë³´ ì˜ìƒ (ê¸°ë³¸ í•„í„°ë§ ì ìš©ë¨)`);
        
        if (searchResults.length === 0) {
          console.log('âš ï¸ ë” ì´ìƒ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
          break;
        }

        // 2ë‹¨ê³„: videos.listë¡œ ìƒì„¸ ì •ë³´ ë° ì¬ìƒ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
        console.log('2ï¸âƒ£ ì˜ìƒ ìƒì„¸ ì •ë³´ ì¡°íšŒ ì¤‘...');
        const videoIds = searchResults.map(item => item.id.videoId);
        const videosResponse = await axios.get(`${this.youtubeApiUrl}/videos`, {
          params: {
            key: this.apiKey,
            part: 'snippet,contentDetails,status,statistics',
            id: videoIds.join(','),
            hl: 'ko',
            regionCode: 'KR'
          }
        });

        const detailedVideos = videosResponse.data.items || [];

        // 3ë‹¨ê³„: ì—„ê²©í•œ ì¬ìƒ ê°€ëŠ¥ Shorts í•„í„°ë§
        console.log('3ï¸âƒ£ ì—„ê²©í•œ ì¬ìƒ ê°€ëŠ¥ ì˜ìƒ í•„í„°ë§ ì¤‘...');
        const playableShorts = detailedVideos.filter(video => {
          // ì„ë² ë“œ ê°€ëŠ¥ ì—¬ë¶€ (ì´ë¯¸ search.listì—ì„œ ê±¸ë €ì§€ë§Œ ì¬í™•ì¸)
          if (!video.status.embeddable) return false;
          
          // ê³µê°œ ìƒíƒœ
          if (video.status.privacyStatus !== 'public') return false;
          
          // ì§€ì—­ ì°¨ë‹¨ í™•ì¸
          const restrictions = video.contentDetails.regionRestriction;
          if (restrictions) {
            if (restrictions.blocked?.includes('KR')) return false;
            if (restrictions.allowed && !restrictions.allowed.includes('KR')) return false;
          }
          
          // Shorts ê¸¸ì´ í™•ì¸ (60ì´ˆ ì´í•˜, 5ì´ˆ ì´ìƒ)
          const duration = this.parseISO8601Duration(video.contentDetails.duration);
          if (duration > 60 || duration < 5) return false;
          
          // ì—…ë¡œë“œ ë¼ì´ì„ ìŠ¤ í™•ì¸ (ì„ íƒì )
          if (video.status.license === 'creativeCommon') {
            // Creative Commons ë¼ì´ì„ ìŠ¤ëŠ” í—ˆìš©
          }
          
          return true;
        });

        const pageFilteringRatio = searchResults.length > 0 ? (playableShorts.length / searchResults.length * 100).toFixed(1) : 0;
        console.log(`âœ… í˜ì´ì§€ ${pageCount} í•„í„°ë§: ${playableShorts.length}/${searchResults.length} ì˜ìƒ (${pageFilteringRatio}% í†µê³¼)`);
        
        // ì´ í˜ì´ì§€ì˜ ì¬ìƒ ê°€ëŠ¥í•œ ì˜ìƒë“¤ì„ ì „ì²´ ëª©ë¡ì— ì¶”ê°€
        allPlayableVideos.push(...playableShorts);
        
        // API ì‚¬ìš©ëŸ‰ ê³„ì‚°
        const pageApiUnits = this.calculateAPIUnits();
        totalApiUnits += pageApiUnits.total;

        // ë‹¤ìŒ í˜ì´ì§€ í† í° í™•ì¸
        currentPageToken = searchResponse.data.nextPageToken;
        
        console.log(`ğŸ“ˆ í˜„ì¬ ëˆ„ì : ${allPlayableVideos.length}ê°œ ì¬ìƒ ê°€ëŠ¥ ì˜ìƒ`);
        
        // ğŸ“‹ ê²°ê³¼ ì¶©ë¶„ì„± ê²€ì‚¬
        if (allPlayableVideos.length >= maxResults) {
          console.log(`ğŸ¯ ëª©í‘œ ë‹¬ì„±: ${maxResults}ê°œ ì´ìƒ í™•ë³´`);
          break;
        } else if (allPlayableVideos.length >= 30) {
          console.log(`âœ… ìµœì†Œ ìš”êµ¬ì‚¬í•­ ì¶©ì¡±: 30ê°œ ì´ìƒ í™•ë³´`);
          break;
        } else if (!currentPageToken) {
          console.log(`âš ï¸ ë” ì´ìƒ í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. (í˜„ì¬: ${allPlayableVideos.length}ê°œ)`);
          break;
        } else {
          console.log(`ğŸ”„ ê²°ê³¼ ë¶€ì¡± (${allPlayableVideos.length}ê°œ < 30ê°œ), ë‹¤ìŒ í˜ì´ì§€ ê²€ìƒ‰ ê³„ì†...`);
        }
      }

      // ğŸ“Š ìµœì¢… í†µê³„
      const totalFilteringRatio = totalCandidates > 0 ? (allPlayableVideos.length / totalCandidates * 100).toFixed(1) : 0;
      console.log(`\nğŸŠ ê²€ìƒ‰ ì™„ë£Œ!`);
      console.log(`  ğŸ“„ ê²€ìƒ‰ëœ í˜ì´ì§€: ${pageCount}ê°œ`);
      console.log(`  ğŸ“Š ì´ í›„ë³´ ì˜ìƒ: ${totalCandidates}ê°œ`);
      console.log(`  âœ… ì¬ìƒ ê°€ëŠ¥ ì˜ìƒ: ${allPlayableVideos.length}ê°œ`);
      console.log(`  ğŸ“ˆ ì „ì²´ í•„í„°ë§ ì„±ê³µë¥ : ${totalFilteringRatio}%`);
      console.log(`  ğŸ’° ì´ API ì‚¬ìš©ëŸ‰: ${totalApiUnits} units`);
      
      // ğŸ¯ ìµœì¢… ê²°ê³¼ëŠ” ìš”ì²­ëœ maxResults ìˆ˜ë§Œí¼ë§Œ ë°˜í™˜
      const finalVideos = allPlayableVideos.slice(0, maxResults);
      console.log(`ğŸ¬ ìµœì¢… ë°˜í™˜: ${finalVideos.length}ê°œ ì˜ìƒ`);

      // í†µê³„ ì—…ë°ì´íŠ¸
      this.stats.totalRequests++;
      this.stats.successfulRequests++;
      this.stats.apiUnitsUsed += totalApiUnits;

      return {
        videos: finalVideos,
        nextPageToken: allPlayableVideos.length > maxResults ? currentPageToken : null, // ë” ë§ì€ ê²°ê³¼ê°€ ìˆëŠ” ê²½ìš°ë§Œ
        filteringStats: {
          pagesSearched: pageCount,
          totalCandidates: totalCandidates,
          totalPlayable: allPlayableVideos.length,
          finalReturned: finalVideos.length,
          overallFilteringRatio: totalFilteringRatio + '%',
          searchEfficiency: (finalVideos.length / totalApiUnits * 100).toFixed(2) + ' videos/100units'
        },
        apiUsage: {
          totalUnits: totalApiUnits,
          breakdown: {
            pagesSearched: pageCount,
            searchUnits: pageCount * 100,
            videosUnits: pageCount * 9,
            avgUnitsPerVideo: (totalApiUnits / Math.max(finalVideos.length, 1)).toFixed(1)
          }
        }
      };

    } catch (error) {
      console.error('âŒ YouTube API ì˜¤ë¥˜:', error);
      this.stats.failedRequests++;
      
      if (error.response?.status === 403) {
        throw new Error('YouTube API í• ë‹¹ëŸ‰ì´ ì´ˆê³¼ë˜ì—ˆê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
      }
      throw error;
    }
  }

  /**
   * ğŸ” ê¸°ë³¸ YouTube ê²€ìƒ‰ (ë‹¨ìˆœ ë²„ì „)
   */
  async searchVideos(query, options = {}) {
    const {
      maxResults = 20,
      videoDuration = 'short',
      regionCode = 'KR',
      relevanceLanguage = 'ko',
      order = 'relevance',
      publishedAfter = null,
      publishedBefore = null,
      safeSearch = 'moderate'
    } = options;

    console.log(`ğŸ” YouTube ê¸°ë³¸ ê²€ìƒ‰: "${query}" (ìµœëŒ€ ${maxResults}ê°œ)`);

    try {
      const searchParams = {
        part: 'snippet',
        q: query,
        type: 'video',
        maxResults,
        regionCode,
        relevanceLanguage,
        order,
        safeSearch
      };

      // ì„ íƒì  íŒŒë¼ë¯¸í„° ì¶”ê°€
      if (videoDuration) searchParams.videoDuration = videoDuration;
      if (publishedAfter) searchParams.publishedAfter = publishedAfter;
      if (publishedBefore) searchParams.publishedBefore = publishedBefore;

      const response = await axios.get(`${this.youtubeApiUrl}/search`, {
        params: {
          ...searchParams,
          key: this.apiKey
        }
      });

      const videos = response.data.items || [];
      console.log(`âœ… ê²€ìƒ‰ ì™„ë£Œ: ${videos.length}ê°œ ì˜ìƒ ë°œê²¬`);

      // í†µê³„ ì—…ë°ì´íŠ¸
      this.stats.totalRequests++;
      this.stats.successfulRequests++;
      this.stats.apiUnitsUsed += 100; // search.list = 100 units

      return {
        videos,
        totalResults: response.data.pageInfo?.totalResults || 0,
        nextPageToken: response.data.nextPageToken,
        apiUnitsUsed: 100
      };

    } catch (error) {
      console.error('âŒ YouTube ê¸°ë³¸ ê²€ìƒ‰ ì‹¤íŒ¨:', error);
      this.stats.failedRequests++;
      throw error;
    }
  }

  /**
   * ğŸ” ë‹¤ì¤‘ í‚¤ì›Œë“œ ê²€ìƒ‰
   */
  async searchMultipleKeywords(keywords, options = {}) {
    const { maxResultsPerKeyword = 10 } = options;
    
    console.log(`ğŸ” ë‹¤ì¤‘ í‚¤ì›Œë“œ ê²€ìƒ‰: ${keywords.join(', ')}`);
    
    const allResults = [];
    
    for (const keyword of keywords) {
      try {
        const result = await this.searchVideos(keyword, {
          ...options,
          maxResults: maxResultsPerKeyword
        });
        
        // í‚¤ì›Œë“œ íƒœê·¸ ì¶”ê°€
        const taggedVideos = result.videos.map(video => ({
          ...video,
          searchKeyword: keyword
        }));
        
        allResults.push(...taggedVideos);
        
        // API í˜¸ì¶œ ê°„ê²© (Rate Limiting ë°©ì§€)
        await this.delay(100);
        
      } catch (error) {
        console.error(`í‚¤ì›Œë“œ "${keyword}" ê²€ìƒ‰ ì‹¤íŒ¨:`, error.message);
      }
    }
    
    console.log(`âœ… ë‹¤ì¤‘ ê²€ìƒ‰ ì™„ë£Œ: ì´ ${allResults.length}ê°œ ì˜ìƒ`);
    
    return {
      videos: allResults,
      totalKeywords: keywords.length,
      successfulKeywords: allResults.length > 0 ? keywords.length : 0
    };
  }

  /**
   * ğŸ¯ ê³ ê¸‰ ì¿¼ë¦¬ ìƒì„± (OR ì—°ì‚°ì í™œìš©)
   */
  generateAdvancedQuery(keywords, options = {}) {
    const { 
      useOrOperator = true,
      maxKeywords = 5,
      addModifiers = true 
    } = options;
    
    const limitedKeywords = keywords.slice(0, maxKeywords);
    
    if (useOrOperator && limitedKeywords.length > 1) {
      // OR ì—°ì‚°ì ì‚¬ìš©
      let query = limitedKeywords.join(' OR ');
      
      if (addModifiers) {
        // YouTube Shorts ê´€ë ¨ ìˆ˜ì‹ì–´ ì¶”ê°€
        query += ' shorts OR ì‡¼ì¸ ';
      }
      
      return query;
    } else {
      // ë‹¨ìˆœ í‚¤ì›Œë“œ ì¡°í•©
      return limitedKeywords.join(' ');
    }
  }

  /**
   * â±ï¸ ISO 8601 Duration íŒŒì‹± (MCP ì„œë²„ì™€ ë™ì¼)
   */
  parseISO8601Duration(duration) {
    // ì…ë ¥ê°’ ê²€ì¦
    if (!duration || typeof duration !== 'string') {
      console.warn('âš ï¸ Invalid duration:', duration);
      return 0;
    }

    try {
      // ISO 8601 duration ì •ê·œì‹ ë§¤ì¹­
      const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
      
      // ë§¤ì¹­ ì‹¤íŒ¨ ì‹œ ì•ˆì „ ì²˜ë¦¬
      if (!match) {
        console.warn('âš ï¸ Duration parsing failed for:', duration);
        return 0;
      }

      // ì•ˆì „í•œ ê°’ ì¶”ì¶œ
      const hours = match[1] ? parseInt(match[1].replace('H', '')) || 0 : 0;
      const minutes = match[2] ? parseInt(match[2].replace('M', '')) || 0 : 0;
      const seconds = match[3] ? parseInt(match[3].replace('S', '')) || 0 : 0;

      const totalSeconds = hours * 3600 + minutes * 60 + seconds;
      
      // ë¹„ì •ìƒì ì¸ ê¸¸ì´ ì²´í¬ (24ì‹œê°„ ì´ˆê³¼ëŠ” ë¹„ì •ìƒ)
      if (totalSeconds > 86400) {
        console.warn('âš ï¸ Abnormally long duration:', duration, `(${totalSeconds}s)`);
        return 0;
      }

      return totalSeconds;
    } catch (error) {
      console.error('âŒ Duration parsing error:', error, 'for duration:', duration);
      return 0;
    }
  }

  /**
   * ğŸ’° API ì‚¬ìš©ëŸ‰ ê³„ì‚° (MCP ì„œë²„ì™€ ë™ì¼)
   */
  calculateAPIUnits(resultCount) {
    // â­ ì •í™•í•œ API ë¹„ìš© ê³„ì‚°
    // search.list: í•­ìƒ 100 units (maxResultsì™€ ê´€ê³„ì—†ì´)
    // videos.list: 1 unit (ê¸°ë³¸) + partsë³„ ì¶”ê°€ ë¹„ìš©
    //   - snippet: +2 units
    //   - contentDetails: +2 units  
    //   - status: +2 units
    //   - statistics: +2 units
    // ì´: 1 + (4 parts Ã— 2) = 9 units
    const searchUnits = 100;
    const videosUnits = 9; // 1 + (snippet + contentDetails + status + statistics) Ã— 2
    
    return {
      search: searchUnits,
      videos: videosUnits,
      total: searchUnits + videosUnits,
      breakdown: {
        'search.list': searchUnits,
        'videos.list (base)': 1,
        'videos.list (parts)': 8,
        'videos.list (total)': videosUnits
      }
    };
  }

  /**
   * ğŸ“Š ê²€ìƒ‰ í†µê³„ ì¡°íšŒ
   */
  getStats() {
    return {
      ...this.stats,
      averageUnitsPerRequest: this.stats.totalRequests > 0 
        ? (this.stats.apiUnitsUsed / this.stats.totalRequests).toFixed(1)
        : 0,
      successRate: this.stats.totalRequests > 0 
        ? ((this.stats.successfulRequests / this.stats.totalRequests) * 100).toFixed(1) + '%'
        : '0%'
    };
  }

  /**
   * ğŸ”„ ì§€ì—° í•¨ìˆ˜
   */
  async delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}

export default YouTubeSearch;

/**
 * ğŸ¯ í¸ì˜ í•¨ìˆ˜ë“¤ - ì§ì ‘ ì‚¬ìš© ê°€ëŠ¥
 */

// ì „ì—­ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± í•¨ìˆ˜
function createYouTubeSearch() {
  const apiKey = process.env.YOUTUBE_API_KEY;
  return new YouTubeSearch(apiKey);
}

/**
 * ğŸ¬ YouTube ì˜ìƒ ê²€ìƒ‰ (í¸ì˜ í•¨ìˆ˜)
 */
export async function searchVideos(query, options = {}) {
  const search = createYouTubeSearch();
  return await search.searchVideos(query, options);
}

/**
 * ğŸ¯ 2ë‹¨ê³„ í•„í„°ë§ YouTube ê²€ìƒ‰ (í¸ì˜ í•¨ìˆ˜) - ë©”ì¸ ê¸°ëŠ¥
 */
export async function searchVideosWithTwoStageFiltering(query, options = {}) {
  const search = createYouTubeSearch();
  return await search.searchYouTubeVideos({
    query: query,
    filters: options
  }, options.maxResults || 20, options.nextPageToken);
}

/**
 * ğŸ” ë‹¤ì¤‘ í‚¤ì›Œë“œ ê²€ìƒ‰ (í¸ì˜ í•¨ìˆ˜)
 */
export async function searchMultipleKeywords(keywords, options = {}) {
  const search = createYouTubeSearch();
  return await search.searchMultipleKeywords(keywords, options);
}

/**
 * ğŸ¯ ê³ ê¸‰ ì¿¼ë¦¬ ìƒì„± (í¸ì˜ í•¨ìˆ˜)
 */
export function generateAdvancedQuery(keywords, options = {}) {
  const search = createYouTubeSearch();
  return search.generateAdvancedQuery(keywords, options);
}

/**
 * ğŸ“Š YouTube ê²€ìƒ‰ í†µê³„ ì¡°íšŒ (í¸ì˜ í•¨ìˆ˜)
 */
export function getYouTubeSearchStats() {
  const search = createYouTubeSearch();
  return search.getStats();
} 