<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>🌊 Momentum API 테스트 페이지 - Wave Team</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .header p {
        opacity: 0.9;
        font-size: 1.1rem;
      }

      .content {
        padding: 30px;
      }

      .api-section {
        margin-bottom: 30px;
        border: 2px solid #f0f0f0;
        border-radius: 15px;
        padding: 20px;
        transition: all 0.3s ease;
      }

      .api-section:hover {
        border-color: #667eea;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
      }

      .api-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
      }

      .api-title .emoji {
        margin-right: 10px;
        font-size: 1.5rem;
      }

      .button-group {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        min-width: 120px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn.small {
        padding: 8px 15px;
        font-size: 12px;
        min-width: 100px;
      }

      .input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        align-items: center;
      }

      .input-group input {
        padding: 10px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        flex: 1;
        max-width: 300px;
      }

      .input-group input:focus {
        outline: none;
        border-color: #667eea;
      }

      .result-area {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-top: 15px;
        font-family: "Monaco", "Menlo", monospace;
        font-size: 12px;
        line-height: 1.5;
        max-height: 400px;
        overflow-y: auto;
        white-space: pre-wrap;
        border: 1px solid #e0e0e0;
      }

      .loading {
        color: #667eea;
        font-style: italic;
      }

      .error {
        color: #dc3545;
        background: #f8d7da;
        border-color: #f5c6cb;
      }

      .success {
        color: #155724;
        background: #d4edda;
        border-color: #c3e6cb;
      }

      .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-online {
        background: #28a745;
      }

      .status-offline {
        background: #dc3545;
      }

      .clear-btn {
        background: #6c757d;
        float: right;
        padding: 5px 10px;
        font-size: 11px;
        margin-left: 10px;
      }

      .footer {
        text-align: center;
        padding: 20px;
        color: #666;
        border-top: 1px solid #f0f0f0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <h1>🌊 Momentum API 테스트</h1>
        <p>YouTube Shorts AI 큐레이션 서비스 - Wave Team</p>
      </div>

      <div class="content">
        <!-- 서버 상태 확인 -->
        <div class="api-section">
          <div class="api-title">
            <span class="emoji">🏥</span>
            서버 상태 확인
          </div>
          <div class="button-group">
            <button class="btn" onclick="checkServerHealth()">
              서버 헬스체크
            </button>
            <button class="btn" onclick="checkApiInfo()">API 정보</button>
            <button class="btn" onclick="checkYouTubeStatus()">
              YouTube 서비스 상태
            </button>
          </div>
          <div id="status-result" class="result-area">
            여기에 서버 상태 정보가 표시됩니다...
          </div>
        </div>

        <!-- Shorts 검색 -->
        <div class="api-section">
          <div class="api-title">
            <span class="emoji">🔍</span>
            Shorts 영상 검색
          </div>
          <div class="input-group">
            <input
              type="text"
              id="search-query"
              placeholder="검색어를 입력하세요 (예: funny, music, gaming)"
              value="funny"
            />
            <input
              type="number"
              id="search-max"
              placeholder="결과 수"
              value="5"
              min="1"
              max="50"
            />
            <select id="search-order">
              <option value="relevance">관련도</option>
              <option value="date">최신순</option>
              <option value="viewCount">조회수</option>
            </select>
          </div>
          <div class="button-group">
            <button class="btn" onclick="searchShorts()">검색하기</button>
            <button class="btn small" onclick="searchPreset('funny')">
              재미있는 영상
            </button>
            <button class="btn small" onclick="searchPreset('music')">
              음악
            </button>
            <button class="btn small" onclick="searchPreset('gaming')">
              게이밍
            </button>
          </div>
          <div id="search-result" class="result-area">
            검색 결과가 여기에 표시됩니다...
          </div>
        </div>

        <!-- 인기 Shorts -->
        <div class="api-section">
          <div class="api-title">
            <span class="emoji">🔥</span>
            인기 Shorts 영상
          </div>
          <div class="input-group">
            <input
              type="number"
              id="trending-max"
              placeholder="결과 수"
              value="10"
              min="1"
              max="50"
            />
            <select id="trending-region">
              <option value="US">미국</option>
              <option value="KR">한국</option>
              <option value="JP">일본</option>
              <option value="GB">영국</option>
            </select>
          </div>
          <div class="button-group">
            <button class="btn" onclick="getTrendingShorts()">
              인기 영상 가져오기
            </button>
          </div>
          <div id="trending-result" class="result-area">
            인기 영상 목록이 여기에 표시됩니다...
          </div>
        </div>

        <!-- 카테고리별 Shorts -->
        <div class="api-section">
          <div class="api-title">
            <span class="emoji">📂</span>
            카테고리별 Shorts
          </div>
          <div class="input-group">
            <input
              type="number"
              id="category-max"
              placeholder="결과 수"
              value="8"
              min="1"
              max="50"
            />
          </div>
          <div class="button-group">
            <button class="btn small" onclick="getByCategory('comedy')">
              코미디
            </button>
            <button class="btn small" onclick="getByCategory('music')">
              음악
            </button>
            <button class="btn small" onclick="getByCategory('gaming')">
              게이밍
            </button>
            <button class="btn small" onclick="getByCategory('education')">
              교육
            </button>
            <button class="btn small" onclick="getByCategory('lifestyle')">
              라이프스타일
            </button>
            <button class="btn small" onclick="getByCategory('food')">
              음식
            </button>
            <button class="btn small" onclick="getByCategory('sports')">
              스포츠
            </button>
            <button class="btn small" onclick="getByCategory('tech')">
              기술
            </button>
          </div>
          <div id="category-result" class="result-area">
            카테고리별 영상이 여기에 표시됩니다...
          </div>
        </div>

        <!-- 캐시 관리 -->
        <div class="api-section">
          <div class="api-title">
            <span class="emoji">🗑️</span>
            캐시 관리
          </div>
          <div class="button-group">
            <button class="btn" onclick="clearCache()">캐시 정리</button>
          </div>
          <div id="cache-result" class="result-area">
            캐시 관리 결과가 여기에 표시됩니다...
          </div>
        </div>

        <!-- 인증 시스템 테스트 -->
        <div class="api-section">
          <div class="api-title">
            <span class="emoji">🔐</span>
            인증 시스템 테스트
          </div>
          <div class="input-group">
            <input
              type="email"
              id="auth-email"
              placeholder="이메일 주소"
              value="test@momentum.com"
            />
            <input
              type="password"
              id="auth-password"
              placeholder="비밀번호"
              value="test123456"
            />
            <input
              type="text"
              id="auth-name"
              placeholder="이름"
              value="테스트 유저"
            />
          </div>
          <div class="button-group">
            <button class="btn" onclick="testSignup()">
              🆕 회원가입 테스트
            </button>
            <button class="btn" onclick="testSignin()">🔑 로그인 테스트</button>
            <button class="btn" onclick="testMe()">👤 내 정보 조회</button>
            <button class="btn" onclick="testSignout()">🚪 로그아웃</button>
          </div>
          <div id="auth-result" class="result-area">
            인증 테스트 결과가 여기에 표시됩니다...
          </div>
        </div>

        <!-- 데이터베이스 연결 테스트 -->
        <div class="api-section">
          <div class="api-title">
            <span class="emoji">🗄️</span>
            데이터베이스 연결 테스트
          </div>
          <div class="button-group">
            <button class="btn" onclick="testDbConnection()">
              🔌 연결 상태 확인
            </button>
            <button class="btn" onclick="testDbQueries()">
              🔍 쿼리 테스트
            </button>
            <button class="btn" onclick="testCacheOperations()">
              💾 캐시 동작 테스트
            </button>
            <button class="btn" onclick="testDbPerformance()">
              ⚡ 성능 테스트
            </button>
          </div>
          <div id="db-result" class="result-area">
            데이터베이스 테스트 결과가 여기에 표시됩니다...
          </div>
        </div>

        <!-- API 사용량 모니터링 -->
        <div class="api-section">
          <div class="api-title">
            <span class="emoji">📊</span>
            API 사용량 모니터링
          </div>
          <div class="button-group">
            <button class="btn" onclick="getApiUsage()">
              📈 현재 사용량 조회
            </button>
            <button class="btn" onclick="getQuotaStatus()">
              ⚖️ 할당량 상태 확인
            </button>
            <button class="btn" onclick="testRateLimiting()">
              🚦 Rate Limiting 테스트
            </button>
            <button class="btn" onclick="simulateHighLoad()">
              🔥 부하 시뮬레이션
            </button>
          </div>
          <div id="api-usage-result" class="result-area">
            API 사용량 정보가 여기에 표시됩니다...
          </div>
        </div>

        <!-- 성능 벤치마크 -->
        <div class="api-section">
          <div class="api-title">
            <span class="emoji">⚡</span>
            성능 벤치마크 테스트
          </div>
          <div class="input-group">
            <input
              type="number"
              id="benchmark-requests"
              placeholder="요청 수"
              value="5"
              min="1"
              max="50"
            />
            <input
              type="number"
              id="benchmark-concurrent"
              placeholder="동시 요청"
              value="2"
              min="1"
              max="10"
            />
          </div>
          <div class="button-group">
            <button class="btn" onclick="benchmarkSearch()">
              🔍 검색 성능 테스트
            </button>
            <button class="btn" onclick="benchmarkAI()">🤖 AI 검색 성능</button>
            <button class="btn" onclick="benchmarkCache()">
              💾 캐시 성능 테스트
            </button>
            <button class="btn" onclick="fullSystemBenchmark()">
              🏆 종합 성능 테스트
            </button>
          </div>
          <div id="benchmark-result" class="result-area">
            성능 테스트 결과가 여기에 표시됩니다...
          </div>
        </div>

        <!-- 에러 처리 테스트 -->
        <div class="api-section">
          <div class="api-title">
            <span class="emoji">🚨</span>
            에러 처리 테스트
          </div>
          <div class="button-group">
            <button class="btn" onclick="testInvalidRequests()">
              ❌ 잘못된 요청 테스트
            </button>
            <button class="btn" onclick="testApiLimits()">
              🚫 API 한도 테스트
            </button>
            <button class="btn" onclick="testNetworkErrors()">
              🌐 네트워크 오류 시뮬레이션
            </button>
            <button class="btn" onclick="testEdgeCases()">
              🔄 엣지 케이스 테스트
            </button>
          </div>
          <div id="error-result" class="result-area">
            에러 처리 테스트 결과가 여기에 표시됩니다...
          </div>
        </div>

        <!-- AI 자연어 검색 -->
        <div class="api-section">
          <div class="api-title">
            <span class="emoji">🤖</span>
            AI 자연어 검색 (MCP 통합)
          </div>
          <div class="input-group">
            <textarea
              id="ai-message"
              placeholder="예: 오늘 피곤한데 힐링되는 영상 보여줘"
              style="height: 80px; resize: vertical"
            >
오늘 피곤한데 힐링되는 영상 보여줘</textarea
            >
          </div>
          <div class="button-group">
            <button class="btn" onclick="testAISearch(true)">
              🧠 AI 분석 (Claude)
            </button>
            <button class="btn" onclick="testAISearch(false)">
              ⚡ 패턴 매칭
            </button>
            <button class="btn small" onclick="setAIExample('피곤')">
              피곤할 때
            </button>
            <button class="btn small" onclick="setAIExample('점심')">
              점심시간
            </button>
            <button class="btn small" onclick="setAIExample('운동')">
              운동하고싶어
            </button>
          </div>
          <div id="ai-search-result" class="result-area">
            AI 검색 결과가 여기에 표시됩니다...
          </div>
        </div>

        <!-- 트렌딩 키워드 -->
        <div class="api-section">
          <div class="api-title">
            <span class="emoji">🔥</span>
            실시간 트렌딩 키워드 (SerpAPI + n8n)
          </div>
          <div class="button-group">
            <button class="btn" onclick="getTrendingKeywords('all')">
              기본 트렌드
            </button>
            <button class="btn" onclick="getRealtimeTrends('KR')">
              🔥 실시간 트렌드
            </button>
            <button class="btn" onclick="getTrendStats()">
              📊 트렌드 통계
            </button>
            <button class="btn small" onclick="getTrendingKeywords('comedy')">
              코미디
            </button>
            <button class="btn small" onclick="getTrendingKeywords('music')">
              음악
            </button>
            <button class="btn small" onclick="getTrendingKeywords('gaming')">
              게이밍
            </button>
            <button class="btn small" onclick="getTrendingKeywords('food')">
              음식
            </button>
            <button class="btn small" onclick="getTimeBasedTrends()">
              ⏰ 시간대별
            </button>
          </div>
          <div id="realtime-trending-result" class="result-area">
            트렌딩 키워드가 여기에 표시됩니다...
          </div>
        </div>

        <!-- 개인화 추천 -->
        <div class="api-section">
          <div class="api-title">
            <span class="emoji">⭐</span>
            개인화 추천 (프리미엄 기능)
          </div>
          <div class="input-group">
            <input
              type="text"
              id="pref-categories"
              placeholder="선호 카테고리 (쉼표로 구분)"
              value="comedy, music"
            />
          </div>
          <div class="button-group">
            <button class="btn" onclick="testPersonalized()">
              개인화 추천 받기
            </button>
          </div>
          <div id="personalized-result" class="result-area">
            개인화 추천 결과가 여기에 표시됩니다...
          </div>
        </div>
      </div>

      <div class="footer">
        <p>🌊 Wave Team | ⚡ Momentum Project | 백엔드 API 테스트 페이지</p>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:3002";

      // 유틸리티 함수들
      function showLoading(elementId) {
        document.getElementById(elementId).innerHTML =
          '<span class="loading">⏳ 로딩 중...</span>';
      }

      function showResult(elementId, data, isError = false) {
        const element = document.getElementById(elementId);
        element.innerHTML = JSON.stringify(data, null, 2);
        element.className = `result-area ${isError ? "error" : "success"}`;

        // Clear 버튼 추가 (이미 존재하는지 더 정확히 확인)
        const parentElement = element.parentNode;
        let existingClearBtn = parentElement.querySelector(".clear-btn");

        if (!existingClearBtn) {
          const clearBtn = document.createElement("button");
          clearBtn.textContent = "지우기";
          clearBtn.className = "btn clear-btn";
          clearBtn.onclick = () => {
            element.innerHTML = "결과가 여기에 표시됩니다...";
            element.className = "result-area";
            // 지우기 버튼도 함께 제거
            clearBtn.remove();
          };
          parentElement.insertBefore(clearBtn, element);
        }
      }

      async function makeApiCall(url, options = {}) {
        try {
          const response = await fetch(url, {
            ...options,
            headers: {
              "Content-Type": "application/json",
              ...options.headers,
            },
          });

          const data = await response.json();
          return { data, status: response.status, ok: response.ok };
        } catch (error) {
          return {
            data: { error: "Network Error", message: error.message },
            status: 0,
            ok: false,
          };
        }
      }

      // 서버 상태 확인 함수들
      async function checkServerHealth() {
        showLoading("status-result");
        const result = await makeApiCall(`${API_BASE}/health`);
        showResult("status-result", result.data, !result.ok);
      }

      async function checkApiInfo() {
        showLoading("status-result");
        const result = await makeApiCall(`${API_BASE}/api/v1`);
        showResult("status-result", result.data, !result.ok);
      }

      async function checkYouTubeStatus() {
        showLoading("status-result");
        const result = await makeApiCall(`${API_BASE}/api/v1/videos/status`);
        showResult("status-result", result.data, !result.ok);
      }

      // Shorts 검색 함수들
      async function searchShorts() {
        const query = document.getElementById("search-query").value.trim();
        const maxResults = document.getElementById("search-max").value;
        const order = document.getElementById("search-order").value;

        if (!query) {
          showResult(
            "search-result",
            { error: "검색어를 입력해주세요!" },
            true
          );
          return;
        }

        showLoading("search-result");
        const url = `${API_BASE}/api/v1/videos/search?q=${encodeURIComponent(
          query
        )}&maxResults=${maxResults}&order=${order}`;
        const result = await makeApiCall(url);
        showResult("search-result", result.data, !result.ok);
      }

      async function searchPreset(query) {
        document.getElementById("search-query").value = query;
        await searchShorts();
      }

      // 인기 Shorts 함수
      async function getTrendingShorts() {
        const maxResults = document.getElementById("trending-max").value;
        const regionCode = document.getElementById("trending-region").value;

        showLoading("trending-result");
        const url = `${API_BASE}/api/v1/videos/trending?maxResults=${maxResults}&regionCode=${regionCode}`;
        const result = await makeApiCall(url);
        showResult("trending-result", result.data, !result.ok);
      }

      // 카테고리별 검색 함수
      async function getByCategory(category) {
        const maxResults = document.getElementById("category-max").value;

        showLoading("category-result");
        const url = `${API_BASE}/api/v1/videos/categories/${category}?maxResults=${maxResults}`;
        const result = await makeApiCall(url);
        showResult("category-result", result.data, !result.ok);
      }

      // 캐시 정리 함수
      async function clearCache() {
        showLoading("cache-result");
        const result = await makeApiCall(
          `${API_BASE}/api/v1/videos/cache/clear`,
          {
            method: "POST",
          }
        );
        showResult("cache-result", result.data, !result.ok);
      }

      // AI 자연어 검색
      async function testAISearch(useAI) {
        const message = document.getElementById("ai-message").value.trim();
        if (!message) {
          showResult(
            "ai-search-result",
            { error: "메시지를 입력해주세요!" },
            true
          );
          return;
        }

        showLoading("ai-search-result");
        const url = `${API_BASE}/api/v1/videos/ai-search`;
        const result = await makeApiCall(url, {
          method: "POST",
          body: JSON.stringify({ message, useAI }),
        });

        if (result.ok && result.data.success) {
          // 결과를 보기 좋게 포맷팅
          const data = result.data.data;
          let formatted = `🎯 추출된 키워드: ${data.extraction.keywords.join(
            ", "
          )}\n`;
          formatted += `📊 분석 방법: ${data.extraction.method}\n`;
          formatted += `💬 AI 응답: ${data.response.message}\n\n`;

          if (data.response.suggestions?.length > 0) {
            formatted += `💡 추천 키워드: ${data.response.suggestions.join(
              ", "
            )}\n\n`;
          }

          formatted += `🎬 검색된 영상: ${data.videos.length}개\n`;
          data.videos.slice(0, 3).forEach((video, i) => {
            formatted += `\n${i + 1}. ${video.title}\n`;
            formatted += `   📺 ${video.channel}\n`;
            formatted += `   👀 조회수: ${
              video.viewCount?.toLocaleString() || "N/A"
            }\n`;
          });

          showResult("ai-search-result", formatted);
        } else {
          showResult("ai-search-result", result.data, true);
        }
      }

      // AI 예제 설정
      function setAIExample(type) {
        const examples = {
          피곤: "오늘 너무 피곤한데 힐링되는 영상 보여줘",
          점심: "점심시간에 볼만한 짧고 재미있는 영상 추천해줘",
          운동: "운동 동기부여되는 영상이나 홈트레이닝 영상 보고싶어",
        };
        document.getElementById("ai-message").value = examples[type] || "";
      }

      // 트렌딩 키워드
      async function getTrendingKeywords(category) {
        showLoading("realtime-trending-result");
        const url = `${API_BASE}/api/v1/videos/trending-keywords?category=${category}`;
        const result = await makeApiCall(url);

        if (result.ok && result.data.success) {
          const data = result.data.data;
          let formatted = `📊 카테고리: ${data.category}\n`;
          formatted += `🔥 트렌딩: ${data.trending.join(", ")}\n`;

          if (data.timeRecommended?.length > 0) {
            formatted += `⏰ 시간대 추천 (${
              data.currentTime.timeOfDay
            }): ${data.timeRecommended.join(", ")}\n`;
          }

          formatted += `\n📅 마지막 업데이트: ${data.lastUpdated}`;
          showResult("realtime-trending-result", formatted);
        } else {
          showResult("realtime-trending-result", result.data, true);
        }
      }

      // 🔥 NEW: 실시간 트렌드 (SerpAPI + n8n)
      async function getRealtimeTrends(region = "KR", forceRefresh = false) {
        showLoading("realtime-trending-result");
        const refreshParam = forceRefresh ? "&refresh=true" : "";
        const url = `${API_BASE}/api/v1/trends/realtime?region=${region}${refreshParam}`;
        const result = await makeApiCall(url);

        // 🐛 디버그: 실제 응답 구조 확인
        console.log("🔍 API 응답 전체:", result);
        console.log("📊 응답 데이터:", result.data);

        if (result.ok && result.data.success) {
          const data = result.data.data;
          const analysis = data.analysis || {};
          const sourceBreakdown = data.sourceBreakdown || {};

          // 🐛 디버그: 트렌드 데이터 구조 확인
          console.log("🎯 트렌드 데이터:", data);
          console.log("📈 분석 데이터:", analysis);
          console.log("📋 소스별 데이터:", sourceBreakdown);

          let formatted = `🔥 실시간 트렌드 (${
            data.region
          }) - 소스: ${data.sources.join(", ")}\n\n`;

          // 📊 데이터 소스별 품질 분석 표시 (안전한 접근)
          if (analysis.bySource && Object.keys(analysis.bySource).length > 0) {
            formatted += `📊 데이터 소스 품질 분석\n`;
            formatted += `${"=".repeat(50)}\n`;

            Object.entries(analysis.bySource).forEach(
              ([source, sourceAnalysis]) => {
                const qualityEmoji = getQualityEmoji(sourceAnalysis.quality);
                formatted += `\n🔸 ${getSourceDisplayName(
                  source
                )} ${qualityEmoji}\n`;
                formatted += `   • 데이터 수: ${sourceAnalysis.count}개\n`;
                formatted += `   • 품질: ${
                  sourceAnalysis.quality
                } (${sourceAnalysis.avgScore?.toFixed(1)}점)\n`;
                formatted += `   • 한국어 비율: ${sourceAnalysis.koreanRatio}%\n`;
                formatted += `   • 고유 키워드: ${sourceAnalysis.uniqueKeywords}개\n`;

                if (sourceAnalysis.searchVolumeAvg > 0) {
                  formatted += `   • 평균 검색량: ${sourceAnalysis.searchVolumeAvg.toLocaleString()}\n`;
                }

                if (sourceAnalysis.issues && sourceAnalysis.issues.length > 0) {
                  formatted += `   • 문제점: ${sourceAnalysis.issues.join(
                    ", "
                  )}\n`;
                }

                // 카테고리 분포 (상위 3개만)
                const topCategories = Object.entries(
                  sourceAnalysis.categoryDistribution || {}
                )
                  .sort(([, a], [, b]) => b - a)
                  .slice(0, 3)
                  .map(([cat, count]) => `${cat}(${count})`)
                  .join(", ");
                if (topCategories) {
                  formatted += `   • 주요 카테고리: ${topCategories}\n`;
                }
              }
            );
          } else {
            formatted += `⚠️ 품질 분석 데이터가 없습니다. 서버를 재시작해주세요.\n\n`;
          }

          // 🎯 추천사항 표시 (안전한 접근)
          if (analysis.recommendations && analysis.recommendations.length > 0) {
            formatted += `\n\n💡 추천사항\n`;
            formatted += `${"=".repeat(50)}\n`;
            analysis.recommendations.forEach((rec, index) => {
              const emoji = getRecommendationEmoji(rec.type);
              formatted += `${emoji} ${rec.message}\n`;
              formatted += `   → ${rec.reason}\n\n`;
            });
          }

          // 📈 전체 통계 (안전한 접근)
          if (analysis.overall) {
            formatted += `📈 전체 통계\n`;
            formatted += `${"=".repeat(50)}\n`;
            formatted += `• 총 트렌드: ${analysis.overall.totalTrends}개\n`;
            formatted += `• 한국어 키워드: ${
              analysis.overall.koreanKeywords
            }개 (${Math.round(
              (analysis.overall.koreanKeywords / analysis.overall.totalTrends) *
                100
            )}%)\n`;
            formatted += `• 평균 점수: ${analysis.overall.avgScore}점\n`;
            formatted += `• 활성 소스: ${analysis.overall.uniqueSources}개\n\n`;
          }

          // 🏆 상위 트렌드 키워드 (Top 10만)
          formatted += `🏆 상위 트렌드 키워드 (Top 10)\n`;
          formatted += `${"=".repeat(50)}\n`;

          if (data.trends && data.trends.length > 0) {
            data.trends.slice(0, 10).forEach((trend, i) => {
              const sourceEmoji = getSourceEmoji(trend.source);
              formatted += `${i + 1}. ${trend.keyword} (${
                trend.category
              }) ${sourceEmoji}\n`;
              formatted += `   📊 점수: ${trend.score} | 🔗 소스: ${trend.source}\n`;

              if (trend.searchVolume > 0) {
                formatted += `   👀 검색량: ${trend.searchVolume.toLocaleString()}\n`;
              }
              if (trend.views > 0) {
                formatted += `   👁️ 조회수: ${trend.views.toLocaleString()}\n`;
              }
              if (trend.originalTitle) {
                formatted += `   📺 원제: ${trend.originalTitle.substring(
                  0,
                  40
                )}...\n`;
              }
              formatted += "\n";
            });
          } else {
            formatted += "❌ 트렌드 데이터가 없습니다.\n\n";
          }

          // 📋 각 소스별 원본 데이터 (간략히) - 안전한 접근
          if (Object.keys(sourceBreakdown).length > 0) {
            formatted += `\n📋 소스별 상세 데이터\n`;
            formatted += `${"=".repeat(50)}\n`;

            Object.entries(sourceBreakdown).forEach(([source, sourceData]) => {
              if (sourceData && sourceData.length > 0) {
                formatted += `\n🔸 ${getSourceDisplayName(source)} (${
                  sourceData.length
                }개)\n`;
                sourceData.slice(0, 3).forEach((item, i) => {
                  formatted += `   ${i + 1}. ${item.keyword} (점수: ${
                    item.score
                  })\n`;
                });
                if (sourceData.length > 3) {
                  formatted += `   ... 외 ${sourceData.length - 3}개\n`;
                }
              }
            });
          }

          formatted += `\n📊 총 ${data.total}개 키워드`;
          formatted += `\n📅 업데이트: ${new Date(
            data.timestamp
          ).toLocaleString()}`;
          formatted += `\n💾 캐시 사용: ${data.cached ? "Yes" : "No"}`;

          if (result.data.meta) {
            formatted += `\n🔧 데이터 소스: ${result.data.meta.dataSources.join(
              ", "
            )}`;
            formatted += `\n⏱️ 업데이트 주기: ${result.data.meta.updateInterval}`;
          }

          // 🔧 직접 DOM 조작으로 문제 해결 시도
          const resultElement = document.getElementById(
            "realtime-trending-result"
          );
          console.log("🎯 realtime-trending-result 요소:", resultElement);

          if (resultElement) {
            resultElement.innerHTML = formatted.replace(/\n/g, "<br>");
            resultElement.className = "result-area success";
            console.log("✅ 직접 DOM 설정 완료");
          } else {
            console.error("❌ realtime-trending-result 요소를 찾을 수 없음");
          }

          // 기존 showResult도 호출 (비교용)
          showResult("realtime-trending-result", formatted);
        } else {
          // 🐛 디버그: 실패 케이스도 상세히 표시
          console.log("❌ API 호출 실패:", result);

          let errorFormatted = `❌ API 호출 실패\n\n`;
          errorFormatted += `HTTP 상태: ${result.status}\n`;
          errorFormatted += `응답 성공: ${result.ok}\n`;
          errorFormatted += `데이터: ${JSON.stringify(result.data, null, 2)}`;

          showResult("realtime-trending-result", errorFormatted, true);
        }
      }

      // 헬퍼 함수들 (전역 스코프)
      function getQualityEmoji(quality) {
        const emojis = {
          excellent: "🌟",
          good: "✅",
          fair: "⚠️",
          poor: "❌",
          very_poor: "💥",
        };
        return emojis[quality] || "❓";
      }

      function getSourceDisplayName(source) {
        const names = {
          googleTrends: "Google Trends",
          youtubeTrends: "YouTube 트렌딩",
          youtubeShorts: "YouTube Shorts",
        };
        return names[source] || source;
      }

      function getSourceEmoji(source) {
        const emojis = {
          google_trends: "🔍",
          youtube_trending: "📺",
          youtube_shorts: "🎬",
        };
        return emojis[source] || "📊";
      }

      function getRecommendationEmoji(type) {
        const emojis = {
          primary_source: "🎯",
          multi_source: "🔗",
          single_source: "⭐",
          improvement: "🔧",
        };
        return emojis[type] || "💡";
      }

      // 📊 트렌드 서비스 통계
      async function getTrendStats() {
        showLoading("realtime-trending-result");
        const result = await makeApiCall(`${API_BASE}/api/v1/trends/stats`);

        if (result.ok && result.data.success) {
          const stats = result.data.data;
          let formatted = `📊 트렌드 서비스 통계\n\n`;
          formatted += `💾 캐시 크기: ${stats.cacheSize}개 항목\n`;
          formatted += `\n🔌 사용 가능한 API:\n`;
          formatted += `  - SerpAPI: ${
            stats.availableApis.serpapi ? "✅ 연결됨" : "❌ 미연결"
          }\n`;
          formatted += `  - n8n 워크플로우: ${
            stats.availableApis.n8n ? "✅ 연결됨" : "❌ 미연결"
          }\n`;
          formatted += `  - YouTube API: ${
            stats.availableApis.youtube ? "✅ 연결됨" : "❌ 미연결"
          }\n`;
          formatted += `\n📅 마지막 업데이트: ${new Date(
            stats.lastUpdate
          ).toLocaleString()}`;

          showResult("realtime-trending-result", formatted);
        } else {
          showResult("realtime-trending-result", result.data, true);
        }
      }

      // ⏰ 시간대별 트렌드 추천
      async function getTimeBasedTrends() {
        showLoading("realtime-trending-result");
        const result = await makeApiCall(
          `${API_BASE}/api/v1/trends/time-based`
        );

        if (result.ok && result.data.success) {
          const data = result.data.data;
          let formatted = `⏰ 시간대별 추천 키워드\n\n`;
          formatted += `🕐 현재 시간: ${data.currentHour}시 (${data.timeCategory})\n`;
          formatted += `📝 설명: ${data.description}\n\n`;
          formatted += `✨ 추천 키워드:\n`;
          data.keywords.forEach((keyword, i) => {
            formatted += `  ${i + 1}. ${keyword}\n`;
          });

          showResult("realtime-trending-result", formatted);
        } else {
          showResult("realtime-trending-result", result.data, true);
        }
      }

      // 개인화 추천
      async function testPersonalized() {
        const categories = document
          .getElementById("pref-categories")
          .value.split(",")
          .map((c) => c.trim())
          .filter((c) => c);

        showLoading("personalized-result");
        const url = `${API_BASE}/api/v1/videos/personalized`;
        const result = await makeApiCall(url, {
          method: "POST",
          body: JSON.stringify({
            userId: "test-user-123",
            preferences: { categories },
            recentViews: [],
          }),
        });

        if (result.ok && result.data.success) {
          const data = result.data.data;
          let formatted = `🎯 추천 키워드: ${data.recommendedKeywords.join(
            ", "
          )}\n`;
          formatted += `📊 개인화 수준: ${data.personalizationLevel}\n`;
          formatted += `⏰ 현재 시간대: ${data.context.timeOfDay}\n\n`;
          formatted += `🎬 추천 영상: ${data.videos.length}개\n`;

          data.videos.slice(0, 3).forEach((video, i) => {
            formatted += `\n${i + 1}. ${video.title}\n`;
            formatted += `   📺 ${video.channel}\n`;
          });

          showResult("personalized-result", formatted);
        } else {
          showResult("personalized-result", result.data, true);
        }
      }

      // 페이지 로드 시 서버 상태 확인
      window.onload = function () {
        checkServerHealth();
      };
    </script>
  </body>
</html>
