---
description: 
globs: 
alwaysApply: true
---
# ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ê°€ì´ë“œ

## ğŸ“Š í…Œì´ë¸” êµ¬ì¡° ì›ì¹™

### ì‚¬ìš©ì ê´€ë ¨ í…Œì´ë¸”
```sql
-- users (Supabase Auth í™•ì¥)
users {
  id: uuid (PK, Supabase Auth)
  email: varchar(255)
  name: varchar(100)
  avatar_url: text
  user_tier: enum('free', 'premium', 'pro')
  created_at: timestamptz
  updated_at: timestamptz
  settings: jsonb
  processing_restrictions: jsonb
}

-- user_preference_profiles (ê°œì¸í™”)
user_preference_profiles {
  id: uuid (PK)
  user_id: uuid (FK â†’ users.id)
  preferred_categories: text[]
  preferred_keywords: text[]
  disliked_categories: text[]
  watch_time_patterns: jsonb
  created_at: timestamptz
  updated_at: timestamptz
}
```

### ì˜ìƒ ìºì‹œ í…Œì´ë¸”
```sql
-- video_cache (YouTube ì˜ìƒ ìºì‹œ)
video_cache {
  id: uuid (PK)
  video_id: varchar(20) (UNIQUE)
  title: text
  channel_name: varchar(255)
  duration: integer
  view_count: bigint
  thumbnail_url: text
  is_playable: boolean
  region_restrictions: jsonb
  cached_at: timestamptz
  expires_at: timestamptz
}

-- search_results_cache (ê²€ìƒ‰ ê²°ê³¼ ìºì‹œ)
search_results_cache {
  id: uuid (PK)
  search_query: varchar(255)
  results: jsonb
  total_results: integer
  cached_at: timestamptz
  expires_at: timestamptz
}
```

### íŠ¸ë Œë“œ ê´€ë ¨ í…Œì´ë¸”
```sql
-- trending_keywords (íŠ¸ë Œë“œ í‚¤ì›Œë“œ)
trending_keywords {
  id: uuid (PK)
  keyword: varchar(255)
  category: varchar(50)
  trend_score: float
  search_volume: integer
  source: enum('bright_data', 'serp_api', 'internal')
  detected_at: timestamptz
  expires_at: timestamptz
}

-- trend_analysis (íŠ¸ë Œë“œ ë¶„ì„)
trend_analysis {
  id: uuid (PK)
  keyword: varchar(255)
  hourly_data: jsonb
  daily_data: jsonb
  analysis_date: date
  created_at: timestamptz
}
```

### ë¡œê·¸ ë° ëª¨ë‹ˆí„°ë§ í…Œì´ë¸”
```sql
-- search_logs (ê²€ìƒ‰ ë¡œê·¸)
search_logs {
  id: uuid (PK)
  user_id: uuid (FK â†’ users.id, nullable)
  search_query: text
  search_type: enum('keyword', 'ai_chat', 'trend')
  results_count: integer
  response_time: integer
  ip_address: inet
  created_at: timestamptz
}

-- api_usage_logs (API ì‚¬ìš©ëŸ‰ ë¡œê·¸)
api_usage_logs {
  id: uuid (PK)
  api_name: varchar(50)
  endpoint: varchar(255)
  units_consumed: integer
  response_time: integer
  status_code: integer
  error_message: text
  created_at: timestamptz
}
```

## ğŸ”§ ë°ì´í„°ë² ì´ìŠ¤ ê·œì¹™

### 1. ëª…ëª… ê·œì¹™
- **í…Œì´ë¸”ëª…**: `snake_case`, ë³µìˆ˜í˜• ì‚¬ìš©
- **ì»¬ëŸ¼ëª…**: `snake_case`, ëª…í™•í•˜ê³  ê°„ê²°í•˜ê²Œ
- **ì¸ë±ìŠ¤ëª…**: `idx_{table}_{column(s)}`
- **FKëª…**: `fk_{table}_{referenced_table}`

### 2. í•„ìˆ˜ ì»¬ëŸ¼
```sql
-- ëª¨ë“  í…Œì´ë¸”ì— í¬í•¨
id: uuid DEFAULT gen_random_uuid() PRIMARY KEY
created_at: timestamptz DEFAULT now()
updated_at: timestamptz DEFAULT now()
```

### 3. JSONB ì‚¬ìš© ê°€ì´ë“œ
```sql
-- ì˜¬ë°”ë¥¸ JSONB ì‚¬ìš©
user_preferences: jsonb DEFAULT '{}'::jsonb
settings: jsonb DEFAULT '{
  "notifications": true,
  "theme": "light",
  "language": "ko"
}'::jsonb

-- ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX idx_users_settings_theme 
ON users USING GIN ((settings->'theme'));
```

### 4. RLS (Row Level Security) ì •ì±…
```sql
-- ì‚¬ìš©ì ë°ì´í„° ë³´í˜¸
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own profile" ON users
  FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can update own profile" ON users
  FOR UPDATE USING (auth.uid() = id);
```

### 5. ìºì‹œ ë§Œë£Œ ì²˜ë¦¬
```sql
-- ìë™ ìºì‹œ ì •ë¦¬ í•¨ìˆ˜
CREATE OR REPLACE FUNCTION cleanup_expired_cache()
RETURNS void AS $$
BEGIN
  DELETE FROM video_cache WHERE expires_at < now();
  DELETE FROM search_results_cache WHERE expires_at < now();
  DELETE FROM trending_keywords WHERE expires_at < now();
END;
$$ LANGUAGE plpgsql;

-- ì •ê¸° ì‹¤í–‰ (cron í™•ì¥ í•„ìš”)
SELECT cron.schedule('cleanup-cache', '0 */4 * * *', 'SELECT cleanup_expired_cache()');
```

### 6. ì„±ëŠ¥ ìµœì í™” ì¸ë±ìŠ¤
```sql
-- ê²€ìƒ‰ ìµœì í™”
CREATE INDEX idx_video_cache_playable ON video_cache(is_playable);
CREATE INDEX idx_video_cache_duration ON video_cache(duration);
CREATE INDEX idx_trending_keywords_score ON trending_keywords(trend_score DESC);
CREATE INDEX idx_search_logs_user_time ON search_logs(user_id, created_at);

-- ë³µí•© ì¸ë±ìŠ¤
CREATE INDEX idx_video_cache_playable_duration 
ON video_cache(is_playable, duration) WHERE is_playable = true;
```

## ğŸš¨ ì£¼ì˜ì‚¬í•­

### ì ˆëŒ€ í•˜ì§€ ë§ê²ƒ
- âŒ **CASCADE ì‚­ì œ** í•¨ë¶€ë¡œ ì‚¬ìš© ê¸ˆì§€
- âŒ **ëŒ€ìš©ëŸ‰ JSONB** ë‹¨ì¼ ì»¬ëŸ¼ì— ì €ì¥ ê¸ˆì§€ (>1MB)
- âŒ **ë¯¼ê°í•œ ë°ì´í„°** í‰ë¬¸ ì €ì¥ ê¸ˆì§€
- âŒ **ì¸ë±ìŠ¤ ì—†ëŠ”** ìì£¼ ì¡°íšŒë˜ëŠ” ì»¬ëŸ¼

### ë°˜ë“œì‹œ í• ê²ƒ
- âœ… **ë°±ì—… ì •ì±…** ì„¤ì • (Point-in-time recovery)
- âœ… **ëª¨ë‹ˆí„°ë§** ì„¤ì • (ì¿¼ë¦¬ ì„±ëŠ¥, ì €ì¥ ê³µê°„)
- âœ… **ë§ˆì´ê·¸ë ˆì´ì…˜** ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
- âœ… **í…ŒìŠ¤íŠ¸ ë°ì´í„°** ì‹œë“œ íŒŒì¼ ìœ ì§€

## ğŸ“ ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ

### ìƒˆ í…Œì´ë¸” ìƒì„± í…œí”Œë¦¿
```sql
-- íŒŒì¼ëª…: YYYYMMDD_create_table_name.sql
CREATE TABLE table_name (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  -- ì»¬ëŸ¼ ì •ì˜
  created_at timestamptz DEFAULT now() NOT NULL,
  updated_at timestamptz DEFAULT now() NOT NULL
);

-- RLS í™œì„±í™”
ALTER TABLE table_name ENABLE ROW LEVEL SECURITY;

-- íŠ¸ë¦¬ê±° ì„¤ì • (updated_at ìë™ ì—…ë°ì´íŠ¸)
CREATE TRIGGER set_updated_at
  BEFORE UPDATE ON table_name
  FOR EACH ROW
  EXECUTE FUNCTION trigger_set_updated_at();

-- ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX idx_table_name_created_at ON table_name(created_at);
```

### ì»¬ëŸ¼ ì¶”ê°€ í…œí”Œë¦¿
```sql
-- íŒŒì¼ëª…: YYYYMMDD_add_column_to_table.sql
ALTER TABLE table_name 
ADD COLUMN new_column data_type DEFAULT default_value;

-- ì¸ë±ìŠ¤ í•„ìš”ì‹œ ì¶”ê°€
CREATE INDEX idx_table_name_new_column ON table_name(new_column);
```
